<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>Official Email | ETERNALGY OS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #0f172a;
            --primary-hover: #1e293b;
            --brand-blue: #3b82f6;
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
        }
        
        * { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; box-sizing: border-box; }
        body { background: linear-gradient(to bottom, #f8fafc 0%, #f1f5f9 100%); color: var(--slate-900); margin: 0; padding: 0; width: 100%; overflow-x: hidden; min-height: 100vh; }

        .nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 0.75rem; color: var(--slate-600); font-weight: 600; font-size: 0.875rem; transition: all 0.15s ease; }
        .nav-link:hover { background: var(--slate-50); color: var(--slate-900); }
        .nav-link.active { background: var(--slate-900); color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }

        .email-item { border-bottom: 1px solid var(--slate-100); transition: background 0.2s; cursor: pointer; }
        .email-item:hover { background: var(--slate-50); }
        .email-item.unread { border-left: 3px solid var(--brand-blue); }

        .sidebar-email { background: white; border-right: 1px solid var(--slate-200); }
        
        @media (max-width: 768px) {
            .mobile-hidden { display: none; }
            .content-container { padding: 1rem; }
        }

        .line-divider { height: 1px; background: var(--slate-200); margin: 0; }
        
        /* Minimalist Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--slate-200); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--slate-300); }
    </style>
</head>
<body class="flex flex-col md:flex-row">

    <!-- Desktop Sidebar -->
    <aside class="sidebar-email hidden md:flex flex-col w-64 fixed h-full z-20 p-6">
        <div class="flex items-center gap-3 mb-10">
            <div class="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center text-white">
                <i class="fa-solid fa-bolt text-lg"></i>
            </div>
            <span class="text-lg font-bold tracking-tight text-slate-900">ETERNALGY OS</span>
        </div>

        <nav class="space-y-1 flex-1">
            <a href="/agent/home" class="nav-link">
                <i class="fa-solid fa-house-chimney w-5"></i>
                <span>Dashboard</span>
            </a>
            <a href="/my-customers" class="nav-link">
                <i class="fa-solid fa-users w-5"></i>
                <span>Customers</span>
            </a>
            <a href="/my-invoice" class="nav-link">
                <i class="fa-solid fa-file-invoice-dollar w-5"></i>
                <span>Invoices</span>
            </a>
            <a href="/my-seda" class="nav-link">
                <i class="fa-solid fa-stamp w-5"></i>
                <span>SEDA Management</span>
            </a>
            <a href="/my-emails" class="nav-link active">
                <i class="fa-solid fa-envelope w-5"></i>
                <span>Official Email</span>
            </a>
            <div class="pt-6 pb-2 px-3">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Email Accounts</span>
            </div>
            <div id="accountList" class="space-y-1">
                <!-- Accounts will be loaded here -->
            </div>
            
            <button onclick="showClaimModal()" class="w-full mt-4 flex items-center gap-2 px-3 py-2 text-xs font-bold text-brand-blue hover:bg-blue-50 rounded-lg transition-colors">
                <i class="fa-solid fa-plus-circle"></i>
                Claim New Account
            </button>
        </nav>

        <div class="mt-auto pt-6">
            <a href="/agent/profile" class="nav-link">
                <i class="fa-solid fa-user-gear w-5"></i>
                <span>Settings</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 w-full md:ml-64 flex flex-col min-h-screen">
        
        <!-- Header -->
        <header class="flex items-center justify-between px-6 py-4 bg-white border-b border-slate-200 sticky top-0 z-30">
            <div class="flex items-center gap-4">
                <h2 id="currentAccountTitle" class="text-sm font-bold text-slate-900">Select an Account</h2>
                <div id="inboxSentToggle" class="hidden flex bg-slate-100 rounded-lg p-1">
                    <button onclick="switchTab('received')" id="btnReceived" class="px-3 py-1 text-[10px] font-bold rounded-md bg-white shadow-sm text-slate-900">Inbox</button>
                    <button onclick="switchTab('sent')" id="btnSent" class="px-3 py-1 text-[10px] font-bold rounded-md text-slate-500">Sent</button>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="showComposeModal()" id="btnCompose" class="hidden md:flex items-center gap-2 bg-slate-900 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-slate-800 transition-all">
                    <i class="fa-solid fa-pen-to-square"></i>
                    <span>Compose</span>
                </button>
                <button onclick="refreshEmails()" class="p-2 text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-rotate"></i>
                </button>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden">
            <!-- Email List -->
            <div id="emailListContainer" class="w-full md:w-1/3 border-right border-slate-200 bg-white overflow-y-auto h-[calc(100vh-65px)]">
                <div id="emailList" class="flex flex-col">
                    <div class="p-10 text-center">
                        <i class="fa-solid fa-envelope-open text-4xl text-slate-100 mb-4"></i>
                        <p class="text-slate-400 text-sm font-medium">Select an account to view emails</p>
                    </div>
                </div>
            </div>

            <!-- Email Detail -->
            <div id="emailDetailContainer" class="hidden md:flex flex-1 flex-col bg-white overflow-y-auto h-[calc(100vh-65px)]">
                <div id="emailDetail" class="p-8">
                    <div class="p-20 text-center">
                        <i class="fa-solid fa-mouse-pointer text-4xl text-slate-100 mb-4"></i>
                        <p class="text-slate-400 text-sm font-medium">Click an email to read</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Claim Account Modal -->
    <div id="claimModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-slate-100">
                <h3 class="text-lg font-bold text-slate-900">Claim Official Email</h3>
                <p class="text-xs text-slate-500 mt-1">Personalize your professional presence.</p>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5">Account Prefix</label>
                    <input type="text" id="prefixInput" placeholder="yourname" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium focus:outline-none focus:border-brand-blue transition-colors">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5">Select Domain</label>
                    <select id="domainSelect" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold text-slate-600 focus:outline-none focus:border-brand-blue transition-colors">
                        <option value="brightfield.com.my">@brightfield.com.my</option>
                        <option value="eternalgy.com">@eternalgy.com</option>
                        <option value="eternalgy.me">@eternalgy.me</option>
                    </select>
                    <p class="text-[9px] text-slate-400 mt-2">Only letters, numbers, dots, and hyphens allowed. Max 3 accounts.</p>
                </div>
            </div>
            <div class="p-6 bg-slate-50 flex gap-3">
                <button onclick="hideClaimModal()" class="flex-1 px-4 py-2.5 rounded-xl font-bold text-slate-500 hover:bg-slate-100 transition-all text-sm">Cancel</button>
                <button onclick="claimAccount()" class="flex-1 bg-slate-900 text-white px-4 py-2.5 rounded-xl font-bold hover:bg-slate-800 transition-all text-sm">Claim Now</button>
            </div>
        </div>
    </div>

    <!-- Compose Email Modal -->
    <div id="composeModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-bold text-slate-900">New Message</h3>
                    <p id="composeFrom" class="text-xs text-slate-500 mt-1">From: ...</p>
                </div>
                <button onclick="hideComposeModal()" class="text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5">Recipient</label>
                    <input type="email" id="composeTo" placeholder="customer@example.com" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium focus:outline-none focus:border-brand-blue transition-colors">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5">Subject</label>
                    <input type="text" id="composeSubject" placeholder="Regarding your solar quote" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium focus:outline-none focus:border-brand-blue transition-colors">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5">Message</label>
                    <textarea id="composeText" rows="10" placeholder="Type your message here..." class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium focus:outline-none focus:border-brand-blue transition-colors resize-none"></textarea>
                </div>
                <!-- Attachments Section -->
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5">Attachments (Max 10MB total)</label>
                    <div id="attachmentList" class="flex flex-wrap gap-2 mb-3"></div>
                    <button type="button" onclick="document.getElementById('fileInput').click()" class="flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 border border-slate-200 rounded-lg text-[10px] font-bold text-slate-600 transition-colors">
                        <i class="fa-solid fa-paperclip"></i>
                        <span>Attach Files</span>
                    </button>
                    <input type="file" id="fileInput" class="hidden" multiple onchange="handleFileSelect(this)">
                </div>
            </div>
            <div class="p-6 bg-slate-50 flex gap-3">
                <button onclick="hideComposeModal()" class="px-6 py-2.5 rounded-xl font-bold text-slate-500 hover:bg-slate-100 transition-all text-sm">Discard</button>
                <button onclick="sendEmail()" id="btnSendEmail" class="flex-1 bg-slate-900 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-slate-800 transition-all text-sm flex items-center justify-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i>
                    <span>Send Message</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentEmail = null;
        let currentTab = 'received';
        let accounts = [];
        let selectedFiles = []; // Track files for composition

        async function loadAccounts() {
            try {
                const res = await fetch('/api/email/accounts');
                const data = await res.json();
                if (data.success) {
                    accounts = data.accounts;
                    renderAccounts();
                    if (accounts.length > 0 && !currentEmail) {
                        selectAccount(accounts[0].full_email);
                    }
                }
            } catch (err) {
                console.error('Failed to load accounts:', err);
            }
        }

        function renderAccounts() {
            const list = document.getElementById('accountList');
            list.innerHTML = accounts.map(acc => `
                <button onclick="selectAccount('${acc.full_email}')" class="nav-link w-full text-left ${currentEmail === acc.full_email ? 'active' : ''}">
                    <i class="fa-solid fa-at w-5"></i>
                    <span class="truncate">${acc.email_prefix}</span>
                </button>
            `).join('');
        }

        function selectAccount(email) {
            currentEmail = email;
            document.getElementById('currentAccountTitle').textContent = email;
            document.getElementById('inboxSentToggle').classList.remove('hidden');
            document.getElementById('btnCompose').classList.remove('hidden');
            renderAccounts();
            loadEmails();
        }

        function showComposeModal() {
            if (!currentEmail) return alert('Please select an account first');
            document.getElementById('composeFrom').textContent = `From: ${currentEmail}`;
            document.getElementById('composeModal').classList.remove('hidden');
        }

        function hideComposeModal() {
            document.getElementById('composeModal').classList.add('hidden');
            // Clear inputs
            document.getElementById('composeTo').value = '';
            document.getElementById('composeSubject').value = '';
            document.getElementById('composeText').value = '';
            selectedFiles = [];
            renderSelectedFiles();
        }

        function handleFileSelect(input) {
            const files = Array.from(input.files);
            
            // Check total size limit (10MB)
            let totalSize = selectedFiles.reduce((acc, f) => acc + f.size, 0);
            for (const file of files) {
                if (file.size > 10 * 1024 * 1024) {
                    alert(`File ${file.name} is too large (max 10MB)`);
                    continue;
                }
                if (totalSize + file.size > 10 * 1024 * 1024) {
                    alert('Total attachment size exceeds 10MB limit');
                    break;
                }
                if (!selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                    selectedFiles.push(file);
                    totalSize += file.size;
                }
            }
            renderSelectedFiles();
            input.value = ''; // Reset input
        }

        function renderSelectedFiles() {
            const list = document.getElementById('attachmentList');
            list.innerHTML = selectedFiles.map((file, index) => `
                <div class="flex items-center gap-2 px-2 py-1 bg-blue-50 border border-blue-100 rounded text-[10px] font-bold text-blue-600">
                    <i class="fa-solid fa-file"></i>
                    <span class="max-w-[100px] truncate">${file.name}</span>
                    <button onclick="removeFile(${index})" class="text-blue-400 hover:text-blue-600 ml-1">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            renderSelectedFiles();
        }

        async function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }

        async function sendEmail() {
            const to = document.getElementById('composeTo').value;
            const subject = document.getElementById('composeSubject').value;
            const text = document.getElementById('composeText').value;
            const btn = document.getElementById('btnSendEmail');

            if (!to || !subject || !text) return alert('Please fill in all fields');

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Sending...';

                // Process attachments
                const attachments = await Promise.all(selectedFiles.map(async (file) => ({
                    filename: file.name,
                    content: await fileToBase64(file)
                })));

                const res = await fetch('/api/email/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        from: currentEmail,
                        to,
                        subject,
                        text,
                        attachments: attachments.length > 0 ? attachments : undefined
                    })
                });

                const data = await res.json();
                if (data.success) {
                    alert('Email sent successfully!');
                    hideComposeModal();
                    if (currentTab === 'sent') loadEmails();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (err) {
                alert('Failed to send email: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Send Message';
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('btnReceived').classList.toggle('bg-white', tab === 'received');
            document.getElementById('btnReceived').classList.toggle('shadow-sm', tab === 'received');
            document.getElementById('btnReceived').classList.toggle('text-slate-900', tab === 'received');
            document.getElementById('btnReceived').classList.toggle('text-slate-500', tab !== 'received');
            
            document.getElementById('btnSent').classList.toggle('bg-white', tab === 'sent');
            document.getElementById('btnSent').classList.toggle('shadow-sm', tab === 'sent');
            document.getElementById('btnSent').classList.toggle('text-slate-900', tab === 'sent');
            document.getElementById('btnSent').classList.toggle('text-slate-500', tab !== 'sent');
            
            loadEmails();
        }

        async function loadEmails() {
            if (!currentEmail) return;
            const list = document.getElementById('emailList');
            list.innerHTML = '<div class="p-10 text-center"><i class="fa-solid fa-circle-notch fa-spin text-2xl text-slate-200"></i></div>';
            
            try {
                const res = await fetch(`/api/email/${currentTab}?email=${encodeURIComponent(currentEmail)}`);
                const data = await res.json();
                if (data.success) {
                    renderEmails(data.emails);
                }
            } catch (err) {
                list.innerHTML = `<div class="p-10 text-center text-red-400 text-xs">${err.message}</div>`;
            }
        }

        function renderEmails(emails) {
            const list = document.getElementById('emailList');
            if (emails.length === 0) {
                list.innerHTML = `
                    <div class="p-10 text-center">
                        <i class="fa-solid fa-inbox text-4xl text-slate-100 mb-4"></i>
                        <p class="text-slate-400 text-sm font-medium">No emails found in ${currentTab}</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = emails.map(email => `
                <div onclick="loadEmailDetail(${email.id})" class="email-item p-4 ${currentTab === 'received' && !email.is_read ? 'unread' : ''}" data-email-id="${email.id}">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-xs font-bold text-slate-900 truncate max-w-[150px]">
                            ${currentTab === 'received' ? email.from_email : email.to_email}
                        </span>
                        <div class="flex flex-col items-end">
                            <span class="text-[9px] text-slate-400 font-bold uppercase whitespace-nowrap">
                                ${new Date(email.received_at || email.sent_at).toLocaleDateString()}
                            </span>
                            ${currentTab === 'sent' ? `
                                <span class="text-[8px] font-black uppercase px-1.5 py-0.5 rounded-md mt-1 ${
                                    email.status === 'sent' ? 'bg-blue-50 text-blue-600' : 
                                    email.status === 'delivered' ? 'bg-green-50 text-green-600' : 
                                    'bg-slate-50 text-slate-500'
                                }">
                                    ${email.status}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    <p class="text-[11px] font-bold text-slate-700 truncate">${email.subject || '(No Subject)'}</p>
                    <p class="text-[10px] text-slate-400 line-clamp-2 mt-1">${email.text_content || '...'}</p>
                </div>
            `).join('');
        }

        async function loadEmailDetail(id) {
            const detail = document.getElementById('emailDetail');
            const container = document.getElementById('emailDetailContainer');
            container.classList.remove('hidden');
            
            detail.innerHTML = '<div class="p-20 text-center"><i class="fa-solid fa-circle-notch fa-spin text-2xl text-slate-200"></i></div>';
            
            try {
                const res = await fetch(`/api/email/details/${id}?type=${currentTab}&email=${encodeURIComponent(currentEmail)}`);
                const data = await res.json();
                if (data.success) {
                    renderEmailDetail(data.email);
                    // Mark as read in UI
                    const el = document.querySelector(`.email-item[data-email-id="${id}"]`);
                    if (el) el.classList.remove('unread');
                }
            } catch (err) {
                detail.innerHTML = `<div class="p-10 text-center text-red-400 text-xs">${err.message}</div>`;
            }
        }

        function renderEmailDetail(email) {
            const detail = document.getElementById('emailDetail');
            detail.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <h1 class="text-xl font-extrabold text-slate-900 tracking-tight">${email.subject || '(No Subject)'}</h1>
                        <div class="flex items-center gap-3 mt-4 p-3 bg-slate-50 rounded-xl border border-slate-100">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(email.from_email)}&background=random" class="w-8 h-8 rounded-full">
                            <div>
                                <p class="text-xs font-bold text-slate-900">${email.from_email}</p>
                                <p class="text-[10px] text-slate-400 font-medium">To: ${email.to_email}</p>
                            </div>
                            <div class="ml-auto flex flex-col items-end gap-1">
                                <div class="text-[10px] text-slate-400 font-bold uppercase">
                                    ${new Date(email.date).toLocaleString()}
                                </div>
                                ${email.status ? `
                                    <span class="text-[9px] font-black uppercase px-2 py-0.5 rounded-lg ${
                                        email.status === 'sent' ? 'bg-blue-100 text-blue-700' : 
                                        email.status === 'delivered' ? 'bg-green-100 text-green-700' : 
                                        'bg-slate-100 text-slate-600'
                                    }">${email.status}</span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="line-divider"></div>
                    
                    <div class="email-body text-sm text-slate-700 leading-relaxed">
                        ${email.html_content || `<div class="whitespace-pre-wrap">${email.text_content}</div>`}
                    </div>

                    ${email.attachments && email.attachments.length > 0 ? `
                        <div class="mt-10 pt-6 border-t border-slate-100">
                            <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Attachments</h4>
                            <div class="flex flex-wrap gap-2">
                                ${email.attachments.map(att => `
                                    <a href="https://ee-mail-production.up.railway.app/attachments/${email.email_id || email.id}/${encodeURIComponent(att.filename)}/download" target="_blank" class="flex items-center gap-2 px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold text-slate-600 hover:bg-slate-100 transition-colors">
                                        <i class="fa-solid fa-file"></i>
                                        <span>${att.filename || 'Attachment'}</span>
                                        <i class="fa-solid fa-download ml-2 text-[10px] text-slate-400"></i>
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function showClaimModal() { document.getElementById('claimModal').classList.remove('hidden'); }
        function hideClaimModal() { document.getElementById('claimModal').classList.add('hidden'); }

        async function claimAccount() {
            const prefix = document.getElementById('prefixInput').value;
            const domain = document.getElementById('domainSelect').value;
            if (!prefix) return alert('Please enter a prefix');
            
            try {
                const res = await fetch('/api/email/accounts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prefix, domain })
                });
                const data = await res.json();
                if (data.success) {
                    hideClaimModal();
                    loadAccounts();
                } else {
                    alert(data.error);
                }
            } catch (err) {
                alert('Failed to claim account');
            }
        }

        function refreshEmails() { loadEmails(); }

        document.addEventListener('DOMContentLoaded', loadAccounts);
    </script>
</body>
</html>