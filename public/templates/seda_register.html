<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>SEDA Registration | ETERNALGY OS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary: #0f172a;
            --primary-hover: #1e293b;
            --brand-blue: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
        }
        
        * { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; box-sizing: border-box; }
        body { background-color: var(--slate-50); color: var(--slate-900); padding-top: env(safe-area-inset-top); padding-bottom: max(2rem, env(safe-area-inset-bottom)); margin: 0; }
        
        /* Navigation Style */
        .top-nav { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid var(--slate-200); position: sticky; top: 0; z-index: 50; }

        /* Card Styles */
        .form-card { background: white; border: 1px solid var(--slate-200); border-radius: 1rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05); padding: 2rem; }
        
        .section-title { font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; color: var(--slate-500); border-bottom: 1px solid var(--slate-100); padding-bottom: 0.75rem; margin-bottom: 2rem; display: flex; align-items: center; gap: 0.75rem; }
        
        /* Input Styles */
        .input-group { margin-bottom: 1.5rem; }
        .input-label { display: block; font-size: 0.7rem; font-weight: 700; color: var(--slate-500); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .input-field { width: 100%; border: 1px solid var(--slate-200); padding: 0.75rem 1rem; font-size: 0.9rem; border-radius: 0.75rem; transition: all 0.15s ease; background-color: white; color: var(--slate-900); }
        .input-field:focus { outline: none; border-color: var(--brand-blue); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .input-field:disabled { opacity: 0.5; cursor: not-allowed; background-color: var(--slate-50); }
        
        /* File Upload */
        .file-upload-box {
            border: 2px dashed var(--slate-200);
            border-radius: 1rem;
            padding: 2rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--slate-50);
            position: relative;
        }
        .file-upload-box:hover { border-color: var(--brand-blue); background: white; }
        
        /* Badges */
        .status-badge { font-size: 0.65rem; font-weight: 800; padding: 0.2rem 0.6rem; border-radius: 0.5rem; border: 1px solid transparent; text-transform: uppercase; }
        .badge-yellow { background: #fefce8; color: #854d0e; border-color: #fef08a; }
        .badge-blue { background: #eff6ff; color: #1e40af; border-color: #dbeafe; }
        .badge-green { background: #f0fdf4; color: #166534; border-color: #dcfce7; }

        /* Checklist Dots */
        .checklist-dot { width: 0.5rem; height: 0.5rem; border-radius: 9999px; }
        .checklist-item { display: flex; align-items: center; gap: 0.375rem; font-size: 9px; font-weight: 700; color: var(--slate-400); text-transform: uppercase; white-space: nowrap; }
        .checklist-item.complete { color: var(--success); }
        .checklist-item.complete .checklist-dot { background-color: var(--success); }
        .checklist-item.incomplete .checklist-dot { background-color: var(--slate-200); }

        .loading-overlay { position: fixed; inset: 0; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px); z-index: 100; display: none; align-items: center; justify-content: center; }

        /* Extracted Data Box */
        .extracted-data-box { margin-top: 0.75rem; padding: 0.75rem; background: #f0fdf4; border: 1px solid #dcfce7; border-radius: 0.75rem; }
        .extracted-item { display: flex; align-items: center; justify-content: space-between; gap: 1rem; padding: 0.25rem 0; border-bottom: 1px solid rgba(0,0,0,0.03); }
        .extracted-label { font-size: 0.65rem; font-weight: 700; color: #166534; text-transform: uppercase; }
        .extracted-value { font-size: 0.8rem; font-weight: 500; color: var(--slate-900); }
        .btn-insert { font-size: 0.65rem; font-weight: 800; color: var(--brand-blue); background: white; border: 1px solid #dbeafe; padding: 0.25rem 0.5rem; border-radius: 0.25rem; transition: all 0.1s; }
        .btn-insert:hover { background: var(--brand-blue); color: white; }

        @media (max-width: 768px) {
            .checklist-grid { grid-template-columns: repeat(3, 1fr) !important; gap: 0.5rem !important; }
        }
    </style>
</head>
<body>
    
    <!-- Extraction Loading Overlay -->
    <div id="loading" class="loading-overlay">
        <div class="text-center">
            <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-slate-900 border-r-transparent align-[-0.125em] mb-4"></div>
            <div class="text-sm font-bold text-slate-900 mb-2" id="loadingText">Processing Document...</div>
            <div class="w-48 h-1.5 bg-slate-200 rounded-full overflow-hidden mx-auto">
                <div id="progressBar" class="h-full bg-slate-900 w-0 transition-all duration-300"></div>
            </div>
        </div>
    </div>

    <!-- Top Navigation -->
    <nav class="top-nav px-4 sm:px-6 lg:px-8 py-3 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <button onclick="goBackToOffice()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                    <i class="fa-solid fa-arrow-left text-slate-600"></i>
                </button>
                <a href="/agent/home" class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-slate-900 rounded-lg flex items-center justify-center text-white">
                        <i class="fa-solid fa-bolt text-sm"></i>
                    </div>
                    <span class="text-sm font-bold tracking-tight text-slate-900">ETERNALGY OS</span>
                </a>
                <div class="h-4 w-px bg-slate-200 mx-2 hidden sm:block"></div>
                <h1 class="text-sm font-bold text-slate-500 hidden sm:block">SEDA Registration</h1>
            </div>

            <div class="flex items-center gap-3">
                <div id="statusBadge" class="status-badge badge-yellow scale-90">DRAFT</div>
                <button onclick="saveSedaForm()" class="p-2 text-slate-600 hover:text-slate-900 transition-colors" title="Save Progress">
                    <i class="fa-solid fa-floppy-disk text-lg"></i>
                </button>
            </div>
        </div>
        <!-- Progress Bar -->
        <div class="absolute bottom-0 left-0 w-full h-[2px] bg-slate-100">
            <div id="formProgress" class="h-full bg-slate-900 w-0 transition-all duration-700"></div>
        </div>
    </nav>

    <!-- Mobile Secondary Action Bar -->
    <div class="md:hidden sticky top-[64px] z-40 bg-white border-b border-slate-200 px-4 py-3 shadow-sm">
        <div class="flex items-center justify-between gap-4">
            <div id="mobileOverallProgress" class="text-[10px] font-black text-slate-400 uppercase">0% DONE</div>
            <div class="flex items-center gap-2">
                <button id="waReminderBtn-mobile" onclick="sendWhatsAppReminder()" class="hidden px-3 py-1.5 bg-emerald-50 text-emerald-700 text-[10px] font-bold rounded-lg border border-emerald-100 flex items-center gap-1.5 uppercase">
                    <i class="fa-brands fa-whatsapp text-sm"></i> Reminder
                </button>
                <button onclick="saveSedaForm()" class="px-3 py-1.5 bg-slate-900 text-white text-[10px] font-bold rounded-lg flex items-center gap-1.5 uppercase">
                    <i class="fa-solid fa-floppy-disk text-sm"></i> Save
                </button>
            </div>
        </div>
    </div>

    <!-- Desktop Checklist Panel (Hidden on Mobile) -->
    <div class="hidden md:block bg-white border-b border-slate-100 py-2">
        <div class="max-w-5xl mx-auto px-8 flex items-center justify-between">
            <div id="overallProgress" class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">0% COMPLETE</div>
            <div class="flex gap-6">
                <div id="check-applicantName" class="checklist-item incomplete"><div class="checklist-dot"></div> Name</div>
                <div id="check-applicantIC" class="checklist-item incomplete"><div class="checklist-dot"></div> IC No</div>
                <div id="check-applicantPhone" class="checklist-item incomplete"><div class="checklist-dot"></div> Contact</div>
                <div id="check-installAddress" class="checklist-item incomplete"><div class="checklist-dot"></div> Address</div>
                <div id="check-mykad" class="checklist-item incomplete"><div class="checklist-dot"></div> MyKad</div>
                <div id="check-tnb_bill_1" class="checklist-item incomplete"><div class="checklist-dot"></div> TNB 1</div>
                <div id="check-property_proof" class="checklist-item incomplete"><div class="checklist-dot"></div> Proof</div>
                <div id="check-tnb_meter" class="checklist-item incomplete"><div class="checklist-dot"></div> Meter</div>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-4 mt-8">
        
        <form id="sedaForm" class="space-y-8">
            
            <!-- Applicant Details -->
            <div class="form-card">
                <h2 class="section-title">
                    <span class="flex items-center justify-center w-6 h-6 rounded bg-slate-900 text-white text-[10px]">01</span>
                    Applicant Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div class="input-group">
                        <label class="input-label">Applicant Name</label>
                        <input type="text" id="applicantName" class="input-field">
                    </div>
                    <div class="input-group">
                        <label class="input-label">IC No / Reg No</label>
                        <input type="text" id="applicantIC" class="input-field" placeholder="e.g. 900101-14-1234">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Contact No</label>
                        <input type="text" id="applicantPhone" class="input-field">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Email Address</label>
                        <input type="email" id="applicantEmail" class="input-field">
                    </div>
                    <div class="input-group md:col-span-2">
                        <label class="input-label">Registered Address</label>
                        <textarea id="applicantAddress" rows="2" class="input-field"></textarea>
                    </div>
                </div>
            </div>

            <!-- Signature Status & Action Block -->
            <div id="signatureBlock" class="form-card border-slate-200 hidden">
                <h2 class="section-title">
                    <span class="flex items-center justify-center w-6 h-6 rounded bg-emerald-600 text-white text-[10px]">
                        <i class="fa-solid fa-signature"></i>
                    </span>
                    Quotation Signature
                </h2>
                
                <div id="signedContent" class="hidden">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Customer Signature found</p>
                    <div class="h-32 flex items-center mb-4 bg-slate-50 rounded-lg border border-slate-100 p-4">
                        <img id="sigImage" src="" alt="Customer Signature" class="max-h-full object-contain mx-auto">
                    </div>
                    <p class="text-xs text-emerald-600 font-bold flex items-center gap-1.5">
                        <i class="fa-solid fa-circle-check"></i>
                        The quotation has been signed by the customer.
                    </p>
                </div>

                <div id="unsignedContent" class="hidden">
                    <div class="p-4 bg-amber-50 border border-amber-100 rounded-xl mb-6">
                        <div class="flex items-start gap-3">
                            <div class="p-2 bg-amber-100 rounded-lg text-amber-600">
                                <i class="fa-solid fa-triangle-exclamation"></i>
                            </div>
                            <div>
                                <h3 class="text-sm font-bold text-amber-900 mb-1">Quotation Not Signed</h3>
                                <p class="text-xs text-amber-700 leading-relaxed">
                                    The customer hasn't signed the official quotation yet. You can view the quotation or share the link with them below.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-3">
                        <button type="button" id="viewInvoiceBtn" class="flex-1 px-6 py-3 bg-white border border-slate-200 text-slate-700 font-bold text-sm rounded-xl hover:bg-slate-50 transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-eye text-slate-400"></i> View Quotation
                        </button>
                        <button type="button" id="shareInvoiceBtn" class="flex-1 px-6 py-3 bg-slate-900 text-white font-bold text-sm rounded-xl shadow-lg hover:bg-slate-800 transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-share-nodes"></i> Share Sign Link
                        </button>
                    </div>
                </div>
            </div>

            <!-- Installation Address -->
            <div class="form-card">
                <h2 class="section-title">
                    <span class="flex items-center justify-center w-6 h-6 rounded bg-slate-900 text-white text-[10px]">02</span>
                    Installation Site
                </h2>
                <div class="space-y-4">
                    <div class="input-group">
                        <label class="input-label">Installation Address</label>
                        <textarea id="installAddress" rows="3" class="input-field" placeholder="Same as registered address?"></textarea>
                        <button type="button" onclick="copyAddress()" class="text-[10px] text-brand-blue font-bold mt-2 hover:underline flex items-center gap-1 uppercase tracking-wider">
                            <i class="fa-solid fa-copy"></i> Copy from Registered Address
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="input-group">
                            <label class="input-label">City</label>
                            <input type="text" id="city" class="input-field">
                        </div>
                        <div class="input-group">
                            <label class="input-label">State</label>
                            <select id="state" class="input-field">
                                <option value="">Select State</option>
                                <option value="Johor">Johor</option>
                                <option value="Kedah">Kedah</option>
                                <option value="Kelantan">Kelantan</option>
                                <option value="Melaka">Melaka</option>
                                <option value="Negeri Sembilan">Negeri Sembilan</option>
                                <option value="Pahang">Pahang</option>
                                <option value="Perak">Perak</option>
                                <option value="Perlis">Perlis</option>
                                <option value="Pulau Pinang">Pulau Pinang</option>
                                <option value="Sabah">Sabah</option>
                                <option value="Sarawak">Sarawak</option>
                                <option value="Selangor">Selangor</option>
                                <option value="Terengganu">Terengganu</option>
                                <option value="Kuala Lumpur">Kuala Lumpur</option>
                                <option value="Putrajaya">Putrajaya</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Postcode</label>
                            <input type="text" id="postcode" class="input-field">
                        </div>
                    </div>
                </div>
            </div>

            <!-- MyKad Upload -->
            <div class="form-card">
                <h2 class="section-title">
                    <span class="flex items-center justify-center w-6 h-6 rounded bg-slate-900 text-white text-[10px]">03</span>
                    MyKad / Identity Document
                </h2>
                <div class="flex gap-2 mb-6">
                    <button type="button" onclick="setMyKadMode('images')" id="btnModeImages" class="px-4 py-2 text-xs font-bold rounded-lg transition-all bg-slate-900 text-white">Upload Images</button>
                    <button type="button" onclick="setMyKadMode('pdf')" id="btnModePdf" class="px-4 py-2 text-xs font-bold rounded-lg transition-all text-slate-500 hover:bg-slate-100">Upload PDF</button>
                </div>

                <div id="sectionMyKadImages" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="input-group">
                        <label class="input-label">MyKad Front</label>
                        <div class="file-upload-box" onclick="document.getElementById('fileMyKadFront').click()">
                            <p class="text-xs text-slate-400 font-medium">Click to upload image</p>
                            <input type="file" id="fileMyKadFront" accept="image/*" class="hidden" onchange="handleExtraction(this, 'mykad')">
                            <div id="previewMyKadFront" class="file-preview"></div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">MyKad Back</label>
                        <div class="file-upload-box" onclick="document.getElementById('fileMyKadBack').click()">
                            <p class="text-xs text-slate-400 font-medium">Click to upload image</p>
                            <input type="file" id="fileMyKadBack" accept="image/*" class="hidden" onchange="handleFile(this, 'previewMyKadBack')">
                            <div id="previewMyKadBack" class="file-preview"></div>
                        </div>
                    </div>
                </div>

                <div id="sectionMyKadPdf" class="hidden">
                    <div class="input-group">
                        <label class="input-label">MyKad PDF (Full Document)</label>
                        <div class="file-upload-box" onclick="document.getElementById('fileMyKadPdf').click()">
                            <p class="text-xs text-slate-400 font-medium">Click to upload PDF</p>
                            <input type="file" id="fileMyKadPdf" accept="application/pdf" class="hidden" onchange="handleExtraction(this, 'mykad')">
                            <div id="previewMyKadPdf" class="file-preview"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TNB Bills -->
            <div class="form-card">
                <h2 class="section-title">
                    <span class="flex items-center justify-center w-6 h-6 rounded bg-slate-900 text-white text-[10px]">04</span>
                    TNB Bills (Last 3 Months)
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="input-group">
                        <label class="input-label">TNB Account No</label>
                        <input type="text" id="tnbAccount" class="input-field">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Phase Type</label>
                        <select id="phaseType" class="input-field">
                            <option value="1">Single Phase (1)</option>
                            <option value="3">Three Phase (3)</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="input-group">
                        <label class="input-label">Bill Month 1 (Latest)</label>
                        <div class="file-upload-box" onclick="document.getElementById('fileTnb1').click()">
                            <p class="text-xs text-slate-400 font-medium">Upload PDF (Auto-Extract)</p>
                            <input type="file" id="fileTnb1" accept="application/pdf" class="hidden" onchange="handleExtraction(this, 'tnb')">
                            <div id="previewTnb1" class="file-preview"></div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Bill Month 2</label>
                        <div class="file-upload-box" onclick="document.getElementById('fileTnb2').click()">
                            <p class="text-xs text-slate-400 font-medium">Upload PDF</p>
                            <input type="file" id="fileTnb2" accept="application/pdf" class="hidden" onchange="handleFile(this, 'previewTnb2')">
                            <div id="previewTnb2" class="file-preview"></div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Bill Month 3</label>
                        <div class="file-upload-box" onclick="document.getElementById('fileTnb3').click()">
                            <p class="text-xs text-slate-400 font-medium">Upload PDF</p>
                            <input type="file" id="fileTnb3" accept="application/pdf" class="hidden" onchange="handleFile(this, 'previewTnb3')">
                            <div id="previewTnb3" class="file-preview"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Emergency Contact -->
            <div class="form-card">
                <h2 class="section-title">
                    <span class="flex items-center justify-center w-6 h-6 rounded bg-slate-900 text-white text-[10px]">05</span>
                    Emergency Contact
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                     <div class="input-group">
                        <label class="input-label">Name</label>
                        <input type="text" id="emergencyName" class="input-field">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Relationship</label>
                        <input type="text" id="emergencyRel" class="input-field">
                    </div>
                     <div class="input-group">
                        <label class="input-label">Contact No</label>
                        <input type="text" id="emergencyPhone" class="input-field">
                    </div>
                </div>
            </div>

            <!-- Supporting Documents -->
            <div class="form-card">
                <h2 class="section-title">
                    <span class="flex items-center justify-center w-6 h-6 rounded bg-slate-900 text-white text-[10px]">06</span>
                    Supporting Documents
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="input-group">
                        <label class="input-label">Property Ownership Proof (PDF/Image)</label>
                        <div class="file-upload-box" onclick="document.getElementById('filePropertyProof').click()">
                            <p class="text-xs text-slate-400 font-medium">Click to upload document</p>
                            <input type="file" id="filePropertyProof" accept="application/pdf,image/*" class="hidden" onchange="handleVerification(this, 'ownership')">
                            <div id="previewPropertyProof" class="file-preview"></div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">TNB Meter Image</label>
                        <div class="file-upload-box" onclick="document.getElementById('fileTnbMeter').click()">
                            <p class="text-xs text-slate-400 font-medium">Click to upload photo</p>
                            <input type="file" id="fileTnbMeter" accept="image/*" class="hidden" onchange="handleVerification(this, 'meter')">
                            <div id="previewTnbMeter" class="file-preview"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="pt-10 flex flex-col sm:flex-row justify-end gap-4">
                <button type="button" onclick="goBackToOffice()" class="w-full sm:w-auto px-8 py-3 border border-slate-200 text-slate-600 font-bold text-sm rounded-xl hover:bg-slate-50 transition-all order-2 sm:order-1">Back to SEDA List</button>
                <button type="submit" class="w-full sm:w-auto px-8 py-3 bg-slate-900 text-white font-bold text-sm rounded-xl shadow-lg transition-all order-1 sm:order-2 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-check-circle"></i> Complete Registration
                </button>
            </div>
        </form>
    </div>

    <script>
        // Determine access mode: public (shareToken) or authenticated (bubble_id)
        const pathParts = window.location.pathname.split('/');
        const isPublicMode = pathParts[1] === 'seda-public' && pathParts[2];
        const shareToken = isPublicMode ? pathParts[2] : null;

        const urlParams = new URLSearchParams(window.location.search);
        const sedaId = urlParams.get('id');
        let fileData = {};
        let extractionInterval = null;
        let linkedInvoiceId = null;
        let customerPhone = null;
        let customerName = null;
        let isWhatsAppVerified = false;

        // --- WhatsApp Reminder Logic ---
        async function checkWhatsAppVerification(phone) {
            if (!phone) return false;
            try {
                const cleanPhone = phone.replace(/\D/g, '').replace(/^0/, '60');
                const res = await fetch('https://whatsapp-api-server-production-c15f.up.railway.app/api/check-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone: cleanPhone })
                });
                const data = await res.json();
                return data.success && data.isWhatsAppUser;
            } catch (err) {
                console.error('WhatsApp check error:', err);
                return false;
            }
        }

        async function sendWhatsAppReminder() {
            if (!customerPhone) return alert('No customer phone number found.');
            const missing = [];
            const checkDone = (id) => {
                const el = document.getElementById(id);
                return el && el.classList.contains('complete');
            };

            if (!checkDone('check-mykad')) missing.push('- MYKAD Copy (Front & Back / PDF)');
            const missingBills = [];
            if (!checkDone('check-tnb_bill_1')) missingBills.push('Latest');
            if (missingBills.length > 0) missing.push(`- TNB Bills (${missingBills.join(', ')})`);
            if (!checkDone('check-tnb_meter')) missing.push('- Photo of Home TNB Meter');
            if (!checkDone('check-property_proof')) missing.push('- Property Ownership Proof (S&P / Geran)');
            
            const eName = document.getElementById('emergencyName').value.trim();
            const ePhone = document.getElementById('emergencyPhone').value.trim();
            if (!eName || !ePhone) missing.push('- Emergency Contact Name & Phone');

            if (missing.length === 0) return alert('All required documents are already uploaded!');

            const cleanPhone = customerPhone.replace(/\D/g, '');
            const finalPhone = cleanPhone.startsWith('60') ? cleanPhone : (cleanPhone.startsWith('0') ? '6' + cleanPhone : '60' + cleanPhone);
            
            const message = `Hi ${customerName || 'Customer'},

This is a friendly reminder from Eternalgy regarding your SEDA registration. We noticed that some documents are still missing:

${missing.join('\n')}

You can upload them directly using this secure link:
${window.location.href}

Thank you!`;
            
            window.open(`https://wa.me/${finalPhone}?text=${encodeURIComponent(message)}`, '_blank');
        }

        function getApiEndpoint() { return isPublicMode ? `/api/v1/seda-public/${shareToken}` : `/api/v1/seda/${sedaId}`; }

        function goBackToOffice() {
            console.log('[SEDA] Navigating back to SEDA list...');
            if (isPublicMode) {
                Swal.fire({
                    icon: 'info',
                    title: 'Public View',
                    text: 'Your progress has been saved. You can close this window.',
                });
                return;
            }
            window.location.replace('/my-seda');
        }

        function startLoading(text = 'Processing...') {
            const overlay = document.getElementById('loading');
            const bar = document.getElementById('progressBar');
            document.getElementById('loadingText').innerText = text;
            overlay.style.display = 'flex';
            bar.style.width = '0%';
            
            let progress = 0;
            clearInterval(extractionInterval);
            extractionInterval = setInterval(() => {
                progress += 0.4;
                if (progress > 99) progress = 99;
                bar.style.width = progress + '%';
            }, 100);
        }

        function stopLoading() {
            clearInterval(extractionInterval);
            document.getElementById('progressBar').style.width = '100%';
            setTimeout(() => { document.getElementById('loading').style.display = 'none'; }, 500);
        }

        function setMyKadMode(mode) {
            const btnImg = document.getElementById('btnModeImages');
            const btnPdf = document.getElementById('btnModePdf');
            const secImg = document.getElementById('sectionMyKadImages');
            const secPdf = document.getElementById('sectionMyKadPdf');

            if (mode === 'images') {
                btnImg.className = 'px-4 py-2 text-xs font-bold rounded-lg bg-slate-900 text-white';
                btnPdf.className = 'px-4 py-2 text-xs font-bold rounded-lg text-slate-500 hover:bg-slate-100';
                secImg.classList.remove('hidden');
                secPdf.classList.add('hidden');
            } else {
                btnPdf.className = 'px-4 py-2 text-xs font-bold rounded-lg bg-slate-900 text-white';
                btnImg.className = 'px-4 py-2 text-xs font-bold rounded-lg text-slate-500 hover:bg-slate-100';
                secPdf.classList.remove('hidden');
                secImg.classList.add('hidden');
            }
        }

        async function handleFile(input, previewId) {
            const file = input.files[0];
            if (!file) return;
            showPreview(file, previewId);
            storeFile(input.id, file);
        }

        function showPreview(file, previewId) {
            const previewEl = document.getElementById(previewId);
            previewEl.style.display = 'block';
            if (file.type.startsWith('image/')) {
                previewEl.innerHTML = `<img src="${URL.createObjectURL(file)}" class="max-h-24 mx-auto rounded mt-2 border border-slate-200">`;
            } else {
                previewEl.innerHTML = `<div class="mt-2 text-blue-600 font-bold text-xs"><i class="fa-solid fa-file-pdf"></i> PDF Selected</div>`;
            }
        }

        function storeFile(inputId, file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const keyMap = {
                    'fileMyKadFront': 'mykad_front', 'fileMyKadBack': 'mykad_back', 'fileMyKadPdf': 'mykad_pdf',
                    'fileTnb1': 'tnb_bill_1', 'fileTnb2': 'tnb_bill_2', 'fileTnb3': 'tnb_bill_3',
                    'filePropertyProof': 'property_proof', 'fileTnbMeter': 'tnb_meter'
                };
                const key = keyMap[inputId];
                if (key) fileData[key] = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function parseExtractionData(json) {
            const root = (json.success && json.data) ? json.data : json;
            if (root.status === 'success' && root.data) return root.data;
            if (root.text) {
                let extracted = {};
                const finalStep = root.text.find(s => s.step_type === 'FINAL');
                if (finalStep?.content?.answer) {
                    try {
                        const parsed = JSON.parse(finalStep.content.answer);
                        if (parsed.answer) extracted.tnb_account = (parsed.answer.match(/NO\.?\s*AKAUN\s*[:\.]?\s*(\d+)/i) || [])[1];
                    } catch (e) {}
                }
                return extracted;
            }
            return root;
        }

        function renderInlineResults(input, type, data) {
            const container = input.closest('.input-group');
            const existing = container.querySelector('.extracted-data-box');
            if (existing) existing.remove();

            const extracted = parseExtractionData(data);
            let itemsHtml = '';

            if (type === 'tnb') {
                if (extracted.tnb_account) itemsHtml += createItemHtml('TNB Account', extracted.tnb_account, 'tnbAccount');
                if (extracted.customer_name) itemsHtml += createItemHtml('Name', extracted.customer_name, 'applicantName');
                if (extracted.address) itemsHtml += createItemHtml('Address', extracted.address, 'installAddress');
            } else {
                const name = extracted.customer_name || extracted.name;
                if (name) itemsHtml += createItemHtml('Name', name, 'applicantName');
                if (extracted.mykad_id) itemsHtml += createItemHtml('IC No', extracted.mykad_id, 'applicantIC');
            }

            if (!itemsHtml) return;

            const box = document.createElement('div');
            box.className = 'extracted-data-box';
            box.innerHTML = `<div class="flex items-center justify-between mb-2"><h4 class="text-[10px] font-bold text-emerald-800 uppercase tracking-wider">Detected Data</h4><button type="button" onclick="this.closest('.extracted-data-box').remove()" class="text-[10px] text-emerald-600 hover:underline">Dismiss</button></div><div class="space-y-1">${itemsHtml}</div>`;
            container.appendChild(box);
        }

        function createItemHtml(label, value, targetId) {
            const safeValue = value.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
            return `<div class="extracted-item"><div><div class="extracted-label">${label}</div><div class="extracted-value">${value}</div></div><button type="button" class="btn-insert" onclick="insertValue('${targetId}', '${safeValue}')">Insert</button></div>`;
        }

        function insertValue(targetId, value) {
            const el = document.getElementById(targetId);
            if (el) {
                el.value = value;
                el.classList.add('ring-2', 'ring-emerald-500');
                setTimeout(() => el.classList.remove('ring-2', 'ring-emerald-500'), 1000);
                el.dispatchEvent(new Event('change'));
            }
        }

        async function handleExtraction(input, type) {
            const file = input.files[0];
            if (!file) return;
            const previewId = input.id === 'fileTnb1' ? 'previewTnb1' : input.id === 'fileMyKadFront' ? 'previewMyKadFront' : 'previewMyKadPdf';
            showPreview(file, previewId);
            storeFile(input.id, file);

            startLoading(type === 'tnb' ? 'Scanning TNB Bill...' : 'Scanning MyKad...');
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const res = await fetch(type === 'tnb' ? '/api/v1/seda/extract-tnb' : '/api/v1/seda/extract-mykad', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ fileData: e.target.result, filename: file.name, sedaId })
                    });
                    const json = await res.json();
                    stopLoading();
                    if (json.success || json.data) renderInlineResults(input, type, json);
                } catch (err) { stopLoading(); alert('Extraction failed'); }
            };
            reader.readAsDataURL(file);
        }

        async function handleVerification(input, type) {
            const file = input.files[0];
            if (!file) return;
            const previewId = type === 'meter' ? 'previewTnbMeter' : 'previewPropertyProof';
            showPreview(file, previewId);
            storeFile(input.id, file);

            startLoading(type === 'meter' ? 'Verifying Meter...' : 'Verifying Ownership...');
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const payload = { fileData: e.target.result, filename: file.name, sedaId };
                    if (type === 'ownership') payload.context = { name: document.getElementById('applicantName').value, address: document.getElementById('installAddress').value };
                    const res = await fetch(type === 'meter' ? '/api/v1/seda/verify-meter' : '/api/v1/seda/verify-ownership', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const json = await res.json();
                    stopLoading();
                    if (json.success) alert(`${type.toUpperCase()} Verification Done`);
                } catch (err) { stopLoading(); }
            };
            reader.readAsDataURL(file);
        }

        function copyAddress() {
            const addr = document.getElementById('applicantAddress').value;
            if(addr) document.getElementById('installAddress').value = addr;
        }

        async function loadData() {
            if (!sedaId && !shareToken) return alert('No ID provided');
            startLoading('Loading Data...');
            try {
                const res = await fetch(getApiEndpoint());
                const json = await res.json();
                if (json.success) {
                    const data = json.data;
                    if (document.getElementById('statusBadge')) document.getElementById('statusBadge').textContent = data.reg_status || 'DRAFT';
                    if (document.getElementById('adminStatusBadge')) document.getElementById('adminStatusBadge').textContent = `ADMIN: ${data.seda_status || 'PENDING'}`;
                    customerName = data.customer_profile?.name || '';
                    customerPhone = data.customer_profile?.phone || '';
                    if (customerPhone) {
                        checkWhatsAppVerification(customerPhone).then(v => { 
                            if(v) {
                                document.getElementById('waReminderBtn')?.classList.remove('hidden');
                                document.getElementById('waReminderBtn-mobile')?.classList.remove('hidden');
                            }
                        });
                    }
                    
                    document.getElementById('applicantName').value = data.customer_profile?.name || '';
                    document.getElementById('applicantPhone').value = data.customer_profile?.phone || data.e_contact_no || '';
                    document.getElementById('applicantEmail').value = data.e_email || data.customer_profile?.email || '';
                    document.getElementById('applicantIC').value = data.ic_no || ''; 
                    document.getElementById('applicantAddress').value = [data.customer_profile?.address, data.customer_profile?.city, data.customer_profile?.state, data.customer_profile?.postcode].filter(Boolean).join(', ');
                    document.getElementById('installAddress').value = data.installation_address || '';
                    document.getElementById('city').value = data.city || '';
                    document.getElementById('state').value = data.state || '';
                    document.getElementById('postcode').value = data.postcode || '';
                    document.getElementById('tnbAccount').value = data.tnb_account_no || '';
                    document.getElementById('phaseType').value = data.phase_type || '1';
                    document.getElementById('emergencyName').value = data.e_contact_name || '';
                    document.getElementById('emergencyRel').value = data.e_contact_relationship || '';
                    document.getElementById('emergencyPhone').value = data.e_contact_no || '';

                    const showExisting = (url, previewId) => {
                        if (!url) return;
                        const previewEl = document.getElementById(previewId);
                        const inputGroup = previewEl.closest('.input-group');
                        let viewBox = inputGroup.querySelector('.existing-file-view');
                        if (!viewBox) {
                            viewBox = document.createElement('div');
                            viewBox.className = 'existing-file-view mt-3 p-3 bg-slate-50 border border-slate-200 rounded-lg flex items-center justify-between text-[10px]';
                            inputGroup.appendChild(viewBox);
                        }
                        const isPdf = url.endsWith('.pdf');
                        viewBox.innerHTML = `${isPdf ? '<span class="text-red-500 font-bold">PDF</span>' : `<img src="${url}" class="w-8 h-8 object-cover rounded">`}<span class="text-slate-500 font-medium">Existing Document</span></div><a href="${url}" target="_blank" class="text-brand-blue font-bold hover:underline">VIEW</a>`;
                    };

                    showExisting(data.ic_copy_front, 'previewMyKadFront');
                    showExisting(data.ic_copy_back, 'previewMyKadBack');
                    showExisting(data.mykad_pdf, 'previewMyKadPdf');
                    showExisting(data.tnb_bill_1, 'previewTnb1');
                    showExisting(data.property_ownership_prove, 'previewPropertyProof');
                    showExisting(data.tnb_meter, 'previewTnbMeter');
                    if (data.mykad_pdf) setMyKadMode('pdf');

                    // --- Handle Signature Block ---
                    const sigBlock = document.getElementById('signatureBlock');
                    const invoice = data.invoice_details;
                    
                    if (invoice) {
                        sigBlock.classList.remove('hidden');
                        const isSigned = invoice.customer_signature && invoice.customer_signature.trim() !== "";
                        
                        if (isSigned) {
                            document.getElementById('signedContent').classList.remove('hidden');
                            document.getElementById('unsignedContent').classList.add('hidden');
                            document.getElementById('sigImage').src = invoice.customer_signature;
                        } else {
                            document.getElementById('signedContent').classList.add('hidden');
                            document.getElementById('unsignedContent').classList.remove('hidden');
                            
                            const invoiceUrl = `${window.location.origin}/view/${invoice.share_token}`;
                            
                            document.getElementById('viewInvoiceBtn').onclick = () => window.open(invoiceUrl, '_blank');
                            document.getElementById('shareInvoiceBtn').onclick = () => shareInvoice(invoiceUrl, invoice.invoice_number);
                        }
                    }
                }
            } catch (err) { alert('Failed to load data'); } finally { stopLoading(); updateFormProgress(); }
        }

        async function shareInvoice(url, invNum) {
            const shareData = {
                title: `Quotation ${invNum}`,
                text: `Hi, please review and sign your solar quotation here: ${invNum}`,
                url: url
            };

            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    // Fallback to clipboard
                    await navigator.clipboard.writeText(url);
                    Swal.fire({
                        icon: 'success',
                        title: 'Link Copied',
                        text: 'Quotation link has been copied to clipboard.',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000
                    });
                }
            } catch (err) {
                console.error('Share failed:', err);
            }
        }

        async function saveSedaForm(e) {
            if (e) e.preventDefault();
            startLoading('Saving Changes...');
            const payload = {
                installation_address: document.getElementById('installAddress').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                postcode: document.getElementById('postcode').value,
                tnb_account_no: document.getElementById('tnbAccount').value,
                phase_type: document.getElementById('phaseType').value,
                e_contact_name: document.getElementById('emergencyName').value,
                e_contact_relationship: document.getElementById('emergencyRel').value,
                e_contact_no: document.getElementById('emergencyPhone').value,
                ...fileData
            };
            try {
                const res = await fetch(getApiEndpoint(), { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const json = await res.json();
                if (json.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Progress Saved',
                        text: 'Your registration details have been updated successfully.',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                    // Refresh data to show any server-side updates/filenames
                    await loadData();
                } else throw new Error(json.error);
            } catch (err) { alert('Error: ' + err.message); } finally { stopLoading(); }
        }

        function updateFormProgress() {
            const items = [
                { id: 'check-applicantName', fields: ['applicantName'] },
                { id: 'check-applicantIC', fields: ['applicantIC'] },
                { id: 'check-applicantPhone', fields: ['applicantPhone'] },
                { id: 'check-installAddress', fields: ['installAddress'] },
                { id: 'check-mykad', files: ['mykad_front', 'mykad_back', 'mykad_pdf'] },
                { id: 'check-tnb_bill_1', files: ['tnb_bill_1'] },
                { id: 'check-property_proof', files: ['property_proof'] },
                { id: 'check-tnb_meter', files: ['tnb_meter'] }
            ];

            let completedCount = 0;
            items.forEach(item => {
                let isDone = true;
                if (item.fields) item.fields.forEach(fid => { if (!document.getElementById(fid)?.value.trim()) isDone = false; });
                if (item.files) {
                    if (item.id === 'check-mykad') {
                        const hasPdf = fileData.mykad_pdf || !!document.getElementById('previewMyKadPdf').closest('.input-group').querySelector('.existing-file-view');
                        const hasFront = fileData.mykad_front || !!document.getElementById('previewMyKadFront').closest('.input-group').querySelector('.existing-file-view');
                        if (!hasPdf && !hasFront) isDone = false;
                    } else {
                        item.files.forEach(fKey => {
                            const previewId = fKey.startsWith('tnb_bill_') ? 'previewTnb' + fKey.split('_').pop() : fKey === 'property_proof' ? 'previewPropertyProof' : fKey === 'tnb_meter' ? 'previewTnbMeter' : '';
                            const hasExisting = !!document.getElementById(previewId)?.closest('.input-group').querySelector('.existing-file-view');
                            if (!fileData[fKey] && !hasExisting) isDone = false;
                        });
                    }
                }
                const headerEl = document.getElementById(item.id);
                if (headerEl) {
                    if (isDone) { completedCount++; headerEl.className = 'checklist-item complete'; } 
                    else { headerEl.className = 'checklist-item incomplete'; }
                }
            });

            const percent = Math.round((completedCount / items.length) * 100);
            if (document.getElementById('formProgress')) document.getElementById('formProgress').style.width = percent + '%';
            if (document.getElementById('overallProgress')) document.getElementById('overallProgress').innerText = percent + '% COMPLETE';
            if (document.getElementById('mobileOverallProgress')) document.getElementById('mobileOverallProgress').innerText = percent + '% DONE';
        }

        document.getElementById('sedaForm').addEventListener('submit', saveSedaForm);
        document.querySelectorAll('input, select, textarea').forEach(el => { el.addEventListener('change', updateFormProgress); el.addEventListener('input', updateFormProgress); });
        
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
    <script src="/js/navigation.js"></script>
</body>
</html>