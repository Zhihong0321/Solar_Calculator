<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEDA Registration V2</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .section-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .input-group { margin-bottom: 1.5rem; }
        .input-label { display: block; font-size: 0.875rem; font-weight: 500; color: #334155; margin-bottom: 0.5rem; }
        .input-field { width: 100%; border: 1px solid #cbd5e1; padding: 0.625rem 0.875rem; font-size: 0.875rem; border-radius: 0.375rem; transition: border-color 0.15s ease; background-color: white; padding-right: 2.5rem !important; }
        .input-field:focus { outline: none; border-color: #0f172a; ring: 1px solid #0f172a; }
        .input-field:disabled { background-color: #f1f5f9; color: #64748b; }
        .btn-primary { background-color: #0f172a; color: white; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.375rem; transition: background-color 0.15s ease; }
        .btn-primary:hover { background-color: #1e293b; }
        
        .file-upload-box {
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8fafc;
            position: relative;
        }
        .file-upload-box:hover { border-color: #94a3b8; background: #f1f5f9; }
        .file-preview { display: none; margin-top: 0.5rem; font-size: 0.75rem; color: #0f172a; font-weight: 500; }
        .file-preview img { max-height: 150px; margin: 0 auto; border-radius: 4px; border: 1px solid #e2e8f0; }
        
        /* Loading Overlay */
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: none; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(4px); }
        .progress-bar-container { width: 300px; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin-top: 1rem; }
        .progress-bar-fill { height: 100%; background: #0f172a; width: 0%; transition: width 0.1s linear; }

        /* Extracted Data Box */
        .extracted-data-box { margin-top: 1rem; padding: 1rem; background-color: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 0.5rem; }
        .extracted-item { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #dcfce7; }
        .extracted-item:last-child { border-bottom: none; }
        .extracted-label { font-size: 0.75rem; color: #166534; font-weight: 600; text-transform: uppercase; }
        .extracted-value { font-size: 0.875rem; color: #14532d; font-weight: 500; margin-top: 0.125rem; }
        .btn-insert { font-size: 0.75rem; background-color: white; border: 1px solid #86efac; color: #166534; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-weight: 600; cursor: pointer; transition: all 0.1s; }
        .btn-insert:hover { background-color: #dcfce7; }

        /* Input Status Indicators */
        .input-wrapper { position: relative; width: 100%; }
        .input-status-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); pointer-events: none; transition: all 0.2s; opacity: 1; color: #e2e8f0; }
        .input-status-icon.valid { color: #10b981; }
        .input-status-icon.invalid { color: #ef4444; }
    </style>
</head>
<body class="py-10 px-4 sm:px-6 lg:px-8">
    
    <!-- Extraction Loading Overlay -->
    <div id="loading" class="loading-overlay">
        <div class="text-center">
            <div class="text-sm font-bold text-slate-900 mb-2" id="loadingText">Processing Document...</div>
            <div class="progress-bar-container">
                <div id="progressBar" class="progress-bar-fill"></div>
            </div>
            <div class="text-xs text-slate-500 mt-2">This may take up to 25 seconds</div>
        </div>
    </div>



    <!-- Granular Status Header -->
    <div class="sticky top-0 z-30 bg-white/95 backdrop-blur border-b border-slate-200 shadow-sm mb-8 -mx-4 sm:-mx-6 lg:-mx-8 px-4 sm:px-6 lg:px-8 py-3 transition-all">
        <div class="max-w-5xl mx-auto">
            <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                <!-- Title & Overall -->
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 bg-emerald-600 rounded-lg shadow-sm flex items-center justify-center text-white font-bold text-sm tracking-wider">V2</div>
                    <div>
                        <div class="flex items-center gap-2">
                            <h1 class="text-sm font-bold text-slate-900 leading-tight">SEDA Registration</h1>
                            <span id="statusBadge" class="px-1.5 py-0.5 bg-yellow-100 text-yellow-800 text-[9px] font-bold rounded border border-yellow-200 uppercase tracking-wider leading-none">DRAFT</span>
                        </div>
                        <span id="overallProgress" class="text-[10px] font-bold text-emerald-600 uppercase tracking-wide">0% COMPLETE</span>
                    </div>
                </div>
                
                <!-- Granular Checklist Grid -->
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-x-4 gap-y-1.5 border-l-0 lg:border-l border-slate-200 lg:pl-6">
                    <div id="check-applicantName" class="flex items-center gap-1.5 text-[9px] font-bold text-slate-400 uppercase">
                        <div class="dot w-2 h-2 rounded-full border-2 border-slate-200"></div> Name
                    </div>
                    <div id="check-applicantIC" class="flex items-center gap-1.5 text-[9px] font-bold text-slate-400 uppercase">
                        <div class="dot w-2 h-2 rounded-full border-2 border-slate-200"></div> IC Number
                    </div>
                    <div id="check-applicantPhone" class="flex items-center gap-1.5 text-[9px] font-bold text-slate-400 uppercase">
                        <div class="dot w-2 h-2 rounded-full border-2 border-slate-200"></div> Contact
                    </div>
                    <div id="check-installAddress" class="flex items-center gap-1.5 text-[9px] font-bold text-slate-400 uppercase">
                        <div class="dot w-2 h-2 rounded-full border-2 border-slate-200"></div> Address
                    </div>
                    <div id="check-mykad" class="flex items-center gap-1.5 text-[9px] font-bold text-slate-400 uppercase">
                        <div class="dot w-2 h-2 rounded-full border-2 border-slate-200"></div> MyKad
                    </div>
                    <div id="check-tnb_bill_1" class="flex items-center gap-1.5 text-[9px] font-bold text-slate-400 uppercase">
                        <div class="dot w-2 h-2 rounded-full border-2 border-slate-200"></div> TNB Bill 1
                    </div>
                    <div id="check-tnb_bill_2" class="flex items-center gap-1.5 text-[9px] font-bold text-slate-400 uppercase">
                        <div class="dot w-2 h-2 rounded-full border-2 border-slate-200"></div> TNB Bill 2
                    </div>
                    <div id="check-tnb_bill_3" class="flex items-center gap-1.5 text-[9px] font-bold text-slate-400 uppercase">
                        <div class="dot w-2 h-2 rounded-full border-2 border-slate-200"></div> TNB Bill 3
                    </div>
                    <div id="check-property_proof" class="flex items-center gap-1.5 text-[9px] font-bold text-slate-400 uppercase">
                        <div class="dot w-2 h-2 rounded-full border-2 border-slate-200"></div> Ownership
                    </div>
                    <div id="check-tnb_meter" class="flex items-center gap-1.5 text-[9px] font-bold text-slate-400 uppercase">
                        <div class="dot w-2 h-2 rounded-full border-2 border-slate-200"></div> Meter Photo
                    </div>
                </div>
            </div>
        </div>
        <!-- Progress Bar Background -->
        <div class="absolute bottom-0 left-0 w-full h-[2px] bg-slate-100">
            <div id="formProgress" class="h-full bg-emerald-500 w-0 transition-all duration-500"></div>
        </div>
    </div>

    <div class="max-w-3xl mx-auto">
        
        <form id="sedaForm" class="space-y-8 bg-white p-8 rounded-xl border border-slate-200 shadow-sm">
            
            <!-- Applicant Details -->
            <div>
                <h2 class="section-title">01. Applicant Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="input-group">
                        <label class="input-label">Applicant Name</label>
                        <input type="text" id="applicantName" class="input-field">
                    </div>
                    <div class="input-group">
                        <label class="input-label">IC No / Reg No</label>
                        <input type="text" id="applicantIC" class="input-field" placeholder="e.g. 900101-14-1234">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Contact No</label>
                        <input type="text" id="applicantPhone" class="input-field">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Email Address</label>
                        <input type="email" id="applicantEmail" class="input-field">
                    </div>
                    <div class="input-group md:col-span-2">
                        <label class="input-label">Registered Address</label>
                        <textarea id="applicantAddress" rows="2" class="input-field"></textarea>
                    </div>
                </div>
            </div>

            <!-- Installation Address -->
            <div>
                <h2 class="section-title">02. Installation Site</h2>
                <div class="space-y-4">
                    <div class="input-group">
                        <label class="input-label">Installation Address</label>
                        <textarea id="installAddress" rows="3" class="input-field" placeholder="Same as registered address?"></textarea>
                        <button type="button" onclick="copyAddress()" class="text-xs text-blue-600 font-medium mt-1 hover:underline">Copy from Registered Address</button>
                    </div>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="input-group">
                            <label class="input-label">City</label>
                            <input type="text" id="city" class="input-field">
                        </div>
                        <div class="input-group">
                            <label class="input-label">State</label>
                            <select id="state" class="input-field">
                                <option value="">Select State</option>
                                <option value="Johor">Johor</option>
                                <option value="Kedah">Kedah</option>
                                <option value="Kelantan">Kelantan</option>
                                <option value="Melaka">Melaka</option>
                                <option value="Negeri Sembilan">Negeri Sembilan</option>
                                <option value="Pahang">Pahang</option>
                                <option value="Perak">Perak</option>
                                <option value="Perlis">Perlis</option>
                                <option value="Pulau Pinang">Pulau Pinang</option>
                                <option value="Sabah">Sabah</option>
                                <option value="Sarawak">Sarawak</option>
                                <option value="Selangor">Selangor</option>
                                <option value="Terengganu">Terengganu</option>
                                <option value="Kuala Lumpur">Kuala Lumpur</option>
                                <option value="Putrajaya">Putrajaya</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MyKad Upload -->
            <div>
                <h2 class="section-title">03. MyKad / Identity Document</h2>
                <div class="flex gap-4 mb-4">
                    <button type="button" onclick="setMyKadMode('images')" id="btnModeImages" class="px-4 py-2 text-sm font-medium rounded border border-slate-300 bg-slate-100 text-slate-600">Upload Images (Front/Back)</button>
                    <button type="button" onclick="setMyKadMode('pdf')" id="btnModePdf" class="px-4 py-2 text-sm font-medium rounded border border-slate-300 bg-white text-slate-600">Upload PDF</button>
                </div>

                <!-- Images Mode -->
                <div id="sectionMyKadImages" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="input-group">
                        <label class="input-label">MyKad Front</label>
                        <div class="file-upload-box" onclick="document.getElementById('fileMyKadFront').click()">
                            <p class="text-xs text-slate-500">Click to upload image</p>
                            <input type="file" id="fileMyKadFront" accept="image/*" class="hidden" onchange="handleExtraction(this, 'mykad')">
                            <div id="previewMyKadFront" class="file-preview"></div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">MyKad Back</label>
                        <div class="file-upload-box" onclick="document.getElementById('fileMyKadBack').click()">
                            <p class="text-xs text-slate-500">Click to upload image</p>
                            <input type="file" id="fileMyKadBack" accept="image/*" class="hidden" onchange="handleFile(this, 'previewMyKadBack')">
                            <div id="previewMyKadBack" class="file-preview"></div>
                        </div>
                    </div>
                </div>

                <!-- PDF Mode -->
                <div id="sectionMyKadPdf" class="hidden">
                    <div class="input-group">
                        <label class="input-label">MyKad PDF (Full Document)</label>
                        <div class="file-upload-box" onclick="document.getElementById('fileMyKadPdf').click()">
                            <p class="text-xs text-slate-500">Click to upload PDF</p>
                            <input type="file" id="fileMyKadPdf" accept="application/pdf" class="hidden" onchange="handleExtraction(this, 'mykad')">
                            <div id="previewMyKadPdf" class="file-preview"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TNB Bills -->
            <div>
                <h2 class="section-title">04. TNB Bills (Last 3 Months)</h2>
                <div class="grid grid-cols-1 gap-4">
                    <div class="input-group">
                        <label class="input-label">TNB Account No</label>
                        <input type="text" id="tnbAccount" class="input-field">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Phase Type</label>
                        <select id="phaseType" class="input-field">
                            <option value="1">Single Phase (1)</option>
                            <option value="3">Three Phase (3)</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="input-group">
                            <label class="input-label">Bill Month 1 (Latest)</label>
                            <div class="file-upload-box" onclick="document.getElementById('fileTnb1').click()">
                                <p class="text-xs text-slate-500">Upload PDF (Auto-Extract)</p>
                                <input type="file" id="fileTnb1" accept="application/pdf" class="hidden" onchange="handleExtraction(this, 'tnb')">
                                <div id="previewTnb1" class="file-preview"></div>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Bill Month 2</label>
                            <div class="file-upload-box" onclick="document.getElementById('fileTnb2').click()">
                                <p class="text-xs text-slate-500">Upload PDF</p>
                                <input type="file" id="fileTnb2" accept="application/pdf" class="hidden" onchange="handleFile(this, 'previewTnb2')">
                                <div id="previewTnb2" class="file-preview"></div>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Bill Month 3</label>
                            <div class="file-upload-box" onclick="document.getElementById('fileTnb3').click()">
                                <p class="text-xs text-slate-500">Upload PDF</p>
                                <input type="file" id="fileTnb3" accept="application/pdf" class="hidden" onchange="handleFile(this, 'previewTnb3')">
                                <div id="previewTnb3" class="file-preview"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Emergency Contact -->
             <div>
                <h2 class="section-title">05. Emergency Contact</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                     <div class="input-group">
                        <label class="input-label">Name</label>
                        <input type="text" id="emergencyName" class="input-field">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Relationship</label>
                        <input type="text" id="emergencyRel" class="input-field">
                    </div>
                     <div class="input-group">
                        <label class="input-label">Contact No</label>
                        <input type="text" id="emergencyPhone" class="input-field">
                    </div>
                </div>
            </div>

            <!-- Supporting Documents -->
            <div>
                <h2 class="section-title">06. Supporting Documents</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="input-group">
                        <label class="input-label">Property Ownership Proof (PDF/Image)</label>
                        <div class="file-upload-box" onclick="document.getElementById('filePropertyProof').click()">
                            <p class="text-xs text-slate-500">Click to upload document</p>
                            <input type="file" id="filePropertyProof" accept="application/pdf,image/*" class="hidden" onchange="handleFile(this, 'previewPropertyProof')">
                            <div id="previewPropertyProof" class="file-preview"></div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">TNB Meter Image</label>
                        <div class="file-upload-box" onclick="document.getElementById('fileTnbMeter').click()">
                            <p class="text-xs text-slate-500">Click to upload photo</p>
                            <input type="file" id="fileTnbMeter" accept="image/*" class="hidden" onchange="handleFile(this, 'previewTnbMeter')">
                            <div id="previewTnbMeter" class="file-preview"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="pt-6 border-t border-slate-200 flex justify-end gap-4">
                <button type="button" onclick="window.close()" class="px-6 py-3 border border-slate-300 text-slate-700 font-semibold rounded-lg hover:bg-slate-50 transition-colors">Close</button>
                <button type="submit" class="btn-primary">Save Changes</button>
            </div>
        </form>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const sedaId = urlParams.get('id');
        let fileData = {};
        let extractionInterval = null;

        // --- Logic for Loading Bar ---
        function startLoading(text = 'Processing...') {
            const overlay = document.getElementById('loading');
            const bar = document.getElementById('progressBar');
            const txt = document.getElementById('loadingText');
            
            overlay.style.display = 'flex';
            txt.innerText = text;
            bar.style.width = '0%';
            
            let progress = 0;
            // 25 seconds = 25000ms. Update every 100ms.
            // Step = 100 / 250 = 0.4%
            clearInterval(extractionInterval);
            extractionInterval = setInterval(() => {
                progress += 0.4;
                if (progress > 99) progress = 99; // Cap at 99
                bar.style.width = progress + '%';
            }, 100);
        }

        function stopLoading() {
            clearInterval(extractionInterval);
            const bar = document.getElementById('progressBar');
            bar.style.width = '100%';
            
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                bar.style.width = '0%';
            }, 500); // Short delay to show 100% completion
        }

        function setMyKadMode(mode) {
            const btnImg = document.getElementById('btnModeImages');
            const btnPdf = document.getElementById('btnModePdf');
            const secImg = document.getElementById('sectionMyKadImages');
            const secPdf = document.getElementById('sectionMyKadPdf');

            if (mode === 'images') {
                btnImg.classList.add('bg-slate-100'); btnImg.classList.remove('bg-white');
                btnPdf.classList.add('bg-white'); btnPdf.classList.remove('bg-slate-100');
                secImg.classList.remove('hidden');
                secPdf.classList.add('hidden');
            } else {
                btnPdf.classList.add('bg-slate-100'); btnPdf.classList.remove('bg-white');
                btnImg.classList.add('bg-white'); btnImg.classList.remove('bg-slate-100');
                secPdf.classList.remove('hidden');
                secImg.classList.add('hidden');
            }
        }

        // --- Logic for File Handling ---
        async function handleFile(input, previewId) {
            const file = input.files[0];
            if (!file) return;
            showPreview(file, previewId);
            storeFile(input.id, file);
        }

        function showPreview(file, previewId) {
            const previewEl = document.getElementById(previewId);
            previewEl.style.display = 'block';
            if (file.type.startsWith('image/')) {
                previewEl.innerHTML = `<img src="${URL.createObjectURL(file)}" alt="Preview"><p class="mt-1">${file.name}</p>`;
            } else {
                previewEl.innerHTML = `<span class="text-blue-600 font-bold">ðŸ“„ PDF Selected</span><p class="mt-1">${file.name}</p>`;
            }
        }

        function storeFile(inputId, file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const keyMap = {
                    'fileMyKadFront': 'mykad_front',
                    'fileMyKadBack': 'mykad_back',
                    'fileMyKadPdf': 'mykad_pdf',
                    'fileTnb1': 'tnb_bill_1',
                    'fileTnb2': 'tnb_bill_2',
                    'fileTnb3': 'tnb_bill_3',
                    'filePropertyProof': 'property_proof',
                    'fileTnbMeter': 'tnb_meter'
                };
                const key = keyMap[inputId];
                if (key) fileData[key] = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- Extraction Logic ---
        function parseExtractionData(json) {
            let extracted = {};
            
            // Unwrap the outer layer from our own backend (sedaRoutes.js)
            const root = (json.success && json.data) ? json.data : json;

            // 1. New TNB API (Structured Response)
            // The API returns { status: "success", data: { ...fields... } }
            if (root.status === 'success' && root.data) {
                return root.data;
            }

            // 2. Perplexity / MyKad Logic (Complex Text Response)
            if (root.text) {
                // 1. Try to find the FINAL step which contains the structured answer
                const finalStep = root.text.find(s => s.step_type === 'FINAL');
                if (finalStep && finalStep.content && finalStep.content.answer) {
                    try {
                        const parsed = JSON.parse(finalStep.content.answer);
                        if (parsed.answer) {
                            const text = parsed.answer;
                            if (!extracted.tnb_account) extracted.tnb_account = (text.match(/NO\.?\s*AKAUN\s*[:\.]?\s*(\d+)/i) || [])[1];
                        }
                    } catch (e) {
                        console.warn('Failed to parse final answer as JSON');
                    }
                }
                
                // 2. Fallback: Check SEARCH_RESULTS for snippets
                const searchStep = root.text.find(s => s.step_type === 'SEARCH_RESULTS');
                if (searchStep && searchStep.content && searchStep.content.web_results) {
                    const snippet = searchStep.content.web_results[0]?.snippet || '';
                    
                    // Account No
                    if (!extracted.tnb_account) {
                        const accMatch = snippet.match(/NO\.?\s*AKAUN\s*[:\.]?\s*(\d+)/i);
                        if (accMatch) extracted.tnb_account = accMatch[1];
                    }

                    // Address & Name Block
                    if (!extracted.address || !extracted.customer_name) {
                        // Strategy 1: Strict match (ALAMAT POS or ALAMAT PREMIS)
                        let addrBlock = (snippet.match(/ALAMAT\s+(?:POS|PREMIS)\s*\n([\s\S]+?)(?=\n\s*\n|\nSila|\nTENAGA|NO\.)/i) || [])[1];
                        
                        // Strategy 2: Loose match (next 6 lines)
                        if (!addrBlock) {
                             const looseMatch = snippet.match(/ALAMAT\s+(?:POS|PREMIS)\s*\n((?:.*\n){1,6})/i);
                             if (looseMatch) addrBlock = looseMatch[1];
                        }

                        if (addrBlock) {
                            const lines = addrBlock.split('\n').map(l => l.trim()).filter(l => l);
                            if (lines.length > 0) {
                                // Assume first line is Name
                                extracted.customer_name = lines[0]; 
                                
                                // Assume remaining lines are Address
                                if (lines.length > 1) {
                                    extracted.address = lines.slice(1).join(', ');
                                }
                            }
                        }
                    }
                    
                    // Attempt IC Number extraction (for MyKad) if not TNB
                    if (!extracted.mykad_id) {
                         const icMatch = snippet.match(/(\d{6}-\d{2}-\d{4})/);
                         if (icMatch) extracted.mykad_id = icMatch[1];
                    }
                }
            } else {
                // Legacy or direct format (fallback)
                extracted = root;
            }
            return extracted;
        }

        function renderInlineResults(input, type, data) {
            // Remove existing result box if any
            const container = input.closest('.input-group');
            const existing = container.querySelector('.extracted-data-box');
            if (existing) existing.remove();

            const extracted = parseExtractionData(data);
            let itemsHtml = '';

            if (type === 'tnb') {
                if (extracted.tnb_account) itemsHtml += createItemHtml('TNB Account', extracted.tnb_account, 'tnbAccount');
                if (extracted.customer_name) itemsHtml += createItemHtml('Customer Name', extracted.customer_name, 'applicantName'); // Optional target
                if (extracted.address) itemsHtml += createItemHtml('Address', extracted.address, 'installAddress');
            } else {
                const name = extracted.customer_name || extracted.name;
                if (name) itemsHtml += createItemHtml('Name', name, 'applicantName');
                if (extracted.mykad_id) itemsHtml += createItemHtml('IC No', extracted.mykad_id, 'applicantIC');
                if (extracted.address) itemsHtml += createItemHtml('Address', extracted.address, 'applicantAddress');
            }

            if (!itemsHtml) {
                // Show "No data found" message
                itemsHtml = `<div class="text-sm text-slate-500 italic p-2">No structured data found in this document.</div>`;
            }

            const box = document.createElement('div');
            box.className = 'extracted-data-box';
            box.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-sm font-bold text-emerald-800 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Detected Data
                    </h4>
                    <button type="button" onclick="this.closest('.extracted-data-box').remove()" class="text-xs text-emerald-600 hover:text-emerald-800">Dismiss</button>
                </div>
                <div class="space-y-1">
                    ${itemsHtml}
                </div>
            `;
            
            container.appendChild(box);
        }

        function createItemHtml(label, value, targetId) {
            // Escape value for attribute to prevent XSS issues in onclick
            const safeValue = value.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
            return `
                <div class="extracted-item">
                    <div>
                        <div class="extracted-label">${label}</div>
                        <div class="extracted-value">${value}</div>
                    </div>
                    <button type="button" class="btn-insert" onclick="insertValue('${targetId}', '${safeValue}')">
                        Insert
                    </button>
                </div>
            `;
        }

        function insertValue(targetId, value) {
            const el = document.getElementById(targetId);
            if (el) {
                el.value = value;
                // Optional: visual feedback
                el.style.borderColor = '#16a34a'; // Green flash
                setTimeout(() => el.style.borderColor = '', 1000);
            } else {
                console.warn('Target input not found:', targetId);
            }
        }

        async function handleExtraction(input, type) {
            console.log('handleExtraction triggered for:', type);
            const file = input.files[0];
            if (!file) {
                console.warn('No file selected');
                return;
            }

            // 1. Show normal preview & store
            try {
                const previewId = input.id === 'fileTnb1' ? 'previewTnb1' : 
                                  input.id === 'fileMyKadFront' ? 'previewMyKadFront' : 'previewMyKadPdf';
                showPreview(file, previewId);
                storeFile(input.id, file);
            } catch (e) {
                console.error('Error showing preview:', e);
                alert('Error showing preview: ' + e.message);
                return;
            }

            // 2. Start Extraction
            startLoading(type === 'tnb' ? 'Scanning TNB Bill...' : 'Scanning MyKad...');

            // Convert file to Base64 for API
            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64 = e.target.result;
                const endpoint = type === 'tnb' ? '/api/v1/seda/extract-tnb' : '/api/v1/seda/extract-mykad';
                
                try {
                    console.log('Sending request to:', endpoint);
                    const res = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ fileData: base64, filename: file.name })
                    });
                    
                    console.log('Response status:', res.status);
                    
                    if (res.status === 413) {
                        throw new Error('File is too large. Please upload a smaller file.');
                    }

                    const json = await res.json();
                    stopLoading();
                    
                    if ((json.success && json.data) || json.text || json.uuid) {
                        renderInlineResults(input, type, json);
                    } else {
                        console.warn('Extraction returned no data or error:', json);
                        alert('Extraction failed: ' + (json.error || 'Unknown error from server'));
                    }
                } catch (err) {
                    stopLoading();
                    console.error('Extraction Error:', err);
                    alert('Auto-extraction failed: ' + err.message);
                }
            };
            
            reader.onerror = function(e) {
                stopLoading();
                console.error('FileReader Error:', e);
                alert('Failed to read file.');
            };

            reader.readAsDataURL(file);
        }

        function copyAddress() {
            const addr = document.getElementById('applicantAddress').value;
            if(addr) document.getElementById('installAddress').value = addr;
        }

        async function loadData() {
            if (!sedaId) return alert('No Registration ID provided');
            startLoading('Loading Data...');
            
            try {
                const res = await fetch(`/api/v1/seda/${sedaId}`);
                const json = await res.json();
                
                if (json.success) {
                    const data = json.data;
                    const cust = data.customer_profile || {};

                    document.getElementById('statusBadge').textContent = data.reg_status || 'DRAFT';
                    
                    // 1. Auto-fill from Customer
                    document.getElementById('applicantName').value = data.linked_customer_name || cust.name || '';
                    document.getElementById('applicantPhone').value = data.e_contact_no || cust.phone || ''; // Fallback mix
                    document.getElementById('applicantEmail').value = data.e_email || cust.email || '';
                    document.getElementById('applicantIC').value = data.ic_no || ''; 
                    
                    const fullAddr = [cust.address, cust.city, cust.state, cust.postcode].filter(Boolean).join(', ');
                    if (!document.getElementById('applicantAddress').value) {
                        document.getElementById('applicantAddress').value = fullAddr;
                    }

                    // 2. Fill SEDA fields
                    document.getElementById('installAddress').value = data.installation_address || '';
                    document.getElementById('city').value = data.city || '';
                    document.getElementById('state').value = data.state || '';
                    document.getElementById('tnbAccount').value = data.tnb_account_no || '';
                    document.getElementById('phaseType').value = data.phase_type || '1';
                    
                    document.getElementById('emergencyName').value = data.e_contact_name || '';
                    document.getElementById('emergencyRel').value = data.e_contact_relationship || '';
                    document.getElementById('emergencyPhone').value = data.e_contact_no || '';

                    // 3. Show existing files
                    const showExisting = (url, previewId) => {
                        if (!url) return;
                        const el = document.getElementById(previewId);
                        el.style.display = 'block';
                        if (url.endsWith('.pdf')) {
                            el.innerHTML = `<a href="${url}" target="_blank" class="text-blue-600 underline">View Existing PDF</a>`;
                        } else {
                            el.innerHTML = `<img src="${url}" alt="Existing"><a href="${url}" target="_blank" class="block mt-1 text-blue-600 underline">View Full Image</a>`;
                        }
                    };

                    showExisting(data.ic_copy_front, 'previewMyKadFront');
                    showExisting(data.ic_copy_back, 'previewMyKadBack');
                    showExisting(data.mykad_pdf, 'previewMyKadPdf');
                    showExisting(data.tnb_bill_1, 'previewTnb1');
                    showExisting(data.tnb_bill_2, 'previewTnb2');
                    showExisting(data.tnb_bill_3, 'previewTnb3');
                    showExisting(data.property_ownership_prove, 'previewPropertyProof');
                    showExisting(data.tnb_meter, 'previewTnbMeter');

                    if (data.mykad_pdf) setMyKadMode('pdf');
                    else setMyKadMode('images');

                }
            } catch (err) {
                console.error(err);
                alert('Failed to load SEDA data');
            } finally {
                stopLoading();
            }
        }

        document.getElementById('sedaForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            startLoading('Saving Changes...');

            const payload = {
                installation_address: document.getElementById('installAddress').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                tnb_account_no: document.getElementById('tnbAccount').value,
                phase_type: document.getElementById('phaseType').value,
                e_contact_name: document.getElementById('emergencyName').value,
                e_contact_relationship: document.getElementById('emergencyRel').value,
                e_contact_no: document.getElementById('emergencyPhone').value,
                // Add new fields
                ...fileData 
            };

            try {
                const res = await fetch(`/api/v1/seda/${sedaId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const json = await res.json();
                if (json.success) {
                    alert('Saved successfully!');
                    // Optionally reload to clean state
                } else {
                    throw new Error(json.error);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            } finally {
                stopLoading();
            }
        });

        // --- Progress & Validation Logic ---
        function injectStatusIndicators() {
            const inputs = document.querySelectorAll('.input-field');
            inputs.forEach(input => {
                if (input.parentNode.classList.contains('input-wrapper')) return;
                
                // Create wrapper
                const wrapper = document.createElement('div');
                wrapper.className = 'input-wrapper';
                input.parentNode.insertBefore(wrapper, input);
                wrapper.appendChild(input);
                
                // Create icon container
                const icon = document.createElement('div');
                icon.className = 'input-status-icon';
                icon.id = 'status-icon-' + input.id;
                // Default to circle
                icon.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke-width="2"></circle></svg>`;
                wrapper.appendChild(icon);
            });
        }

        function updateFormProgress() {
            const items = [
                { id: 'check-applicantName', fields: ['applicantName'] },
                { id: 'check-applicantIC', fields: ['applicantIC'] },
                { id: 'check-applicantPhone', fields: ['applicantPhone'] },
                { id: 'check-installAddress', fields: ['installAddress'] },
                { id: 'check-mykad', files: ['mykad_front', 'mykad_back', 'mykad_pdf'] },
                { id: 'check-tnb_bill_1', files: ['tnb_bill_1'] },
                { id: 'check-tnb_bill_2', files: ['tnb_bill_2'] },
                { id: 'check-tnb_bill_3', files: ['tnb_bill_3'] },
                { id: 'check-property_proof', files: ['property_proof'] },
                { id: 'check-tnb_meter', files: ['tnb_meter'] }
            ];

            let completedCount = 0;

            items.forEach(item => {
                let isDone = true;
                
                // Check fields
                if (item.fields) {
                    item.fields.forEach(fid => {
                        const el = document.getElementById(fid);
                        const icon = document.getElementById('status-icon-' + fid);
                        if (!el || !el.value.trim()) {
                            isDone = false;
                            if (icon) {
                                icon.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke-width="2"></circle></svg>`;
                                icon.className = 'input-status-icon';
                            }
                        } else {
                            if (icon) {
                                icon.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                                icon.className = 'input-status-icon valid';
                            }
                        }
                    });
                }

                // Check files
                if (item.files) {
                    if (item.id === 'check-mykad') {
                        const hasPdf = fileData.mykad_pdf || document.getElementById('previewMyKadPdf').style.display === 'block';
                        const hasFront = fileData.mykad_front || document.getElementById('previewMyKadFront').style.display === 'block';
                        const hasBack = fileData.mykad_back || document.getElementById('previewMyKadBack').style.display === 'block';
                        if (!hasPdf && (!hasFront || !hasBack)) isDone = false;
                    } else {
                        item.files.forEach(fKey => {
                            const previewId = fKey.startsWith('tnb_bill_') ? 'previewTnb' + fKey.split('_').pop() : 
                                            fKey === 'property_proof' ? 'previewPropertyProof' : 
                                            fKey === 'tnb_meter' ? 'previewTnbMeter' : '';
                            
                            const hasFile = fileData[fKey] || (document.getElementById(previewId) && document.getElementById(previewId).style.display === 'block');
                            if (!hasFile) isDone = false;
                        });
                    }
                }

                // Update Header Item
                const headerEl = document.getElementById(item.id);
                if (headerEl) {
                    const dot = headerEl.querySelector('.dot');
                    if (isDone) {
                        completedCount++;
                        headerEl.classList.remove('text-slate-400');
                        headerEl.classList.add('text-emerald-600');
                        dot.className = 'dot w-2 h-2 rounded-full bg-emerald-500 border-2 border-emerald-500';
                        dot.innerHTML = ''; // Keep it a dot but colored
                    } else {
                        headerEl.classList.add('text-slate-400');
                        headerEl.classList.remove('text-emerald-600');
                        dot.className = 'dot w-2 h-2 rounded-full border-2 border-slate-200';
                    }
                }
            });

            const percent = Math.round((completedCount / items.length) * 100);
            const bar = document.getElementById('formProgress');
            const text = document.getElementById('overallProgress');
            if (bar) bar.style.width = percent + '%';
            if (text) text.innerText = percent + '% COMPLETE';
        }

        // Attach listeners
        document.addEventListener('DOMContentLoaded', () => {
            injectStatusIndicators();
            updateFormProgress();
        });

        document.querySelectorAll('input, select, textarea').forEach(el => {
            el.addEventListener('change', updateFormProgress);
            el.addEventListener('input', updateFormProgress);
        });

        // Hook into insertValue
        const originalInsertValue = insertValue;
        insertValue = function(targetId, value) {
            originalInsertValue(targetId, value);
            updateFormProgress();
        };

        // Hook into loadData
        const originalLoadData = loadData;
        loadData = async function() {
            await originalLoadData();
            // Ensure elements are injected before updating status
            injectStatusIndicators(); 
            updateFormProgress();
        };

        // Hook into file handling
        const originalStoreFile = storeFile;
        storeFile = function(inputId, file) {
            originalStoreFile(inputId, file);
            setTimeout(updateFormProgress, 100); // Delay slightly for fileData update
        };

        // Initial call
        // loadData() calls it via hook
        loadData();
    </script>
</body>
</html>
