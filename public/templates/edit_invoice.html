<!DOCTYPE html>
<html>
<head>
    <title>Edit Quotation</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <!-- User Welcome Section -->
        <div id="userWelcome" class="hidden mb-4 flex items-center justify-between bg-blue-50 px-4 py-2 rounded-lg border border-blue-100">
            <span class="text-sm font-medium text-blue-800">Welcome, <span id="userNameDisplay" class="font-bold">User</span></span>
        </div>

        <h1 class="text-2xl font-bold mb-6 text-gray-900">Edit Quotation</h1>
        
        <div id="errorMessage" class="hidden mb-6 p-4 bg-red-50 border-2 border-red-400 rounded-lg">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3 flex-1">
                    <h3 class="text-sm font-semibold text-red-900 mb-1">Error</h3>
                    <p class="text-red-800 font-medium" id="errorText"></p>
                </div>
            </div>
        </div>
        
        <div id="warningMessage" class="hidden mb-6 p-4 bg-yellow-50 border-2 border-yellow-400 rounded-lg">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3 flex-1">
                    <h3 class="text-sm font-semibold text-yellow-900 mb-1">Loading...</h3>
                    <p class="text-yellow-800" id="warningText">Please wait while we load your quotation.</p>
                </div>
            </div>
        </div>
        
        <div id="quotationFormContainer" class="hidden space-y-6">
            <!-- Package Information -->
            <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-300">
                <h2 class="font-bold text-lg mb-3 text-gray-900">Package Information</h2>
                <div class="space-y-2 text-gray-800">
                    <p><strong class="text-gray-900">Name:</strong> <span class="text-gray-800" id="packageNameDisplay">-</span></p>
                    <p><strong class="text-gray-900">Price:</strong> <span class="text-gray-800 font-semibold" id="packagePriceDisplay">RM 0.00</span></p>
                    <div id="packageDescContainer" class="hidden mt-3 pt-3 border-t border-blue-200">
                        <strong class="text-gray-900 block mb-2">Description:</strong>
                        <pre class="whitespace-pre-wrap text-sm text-gray-800 bg-white p-3 rounded border border-gray-200 font-sans" id="packageDescDisplay"></pre>
                    </div>
                </div>
            </div>

            <!-- Quotation Items Preview -->
            <div class="bg-gray-50 p-4 rounded-lg border-2 border-gray-300">
                <h2 class="font-bold text-lg mb-4 text-gray-900">Quotation Items Preview</h2>
                <div id="quotationItemsList" class="space-y-2 mb-4">
                    <!-- Items will be populated by JavaScript -->
                </div>
                <div class="border-t-2 border-gray-300 pt-4 mt-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-gray-900">Subtotal:</span>
                        <span class="font-semibold text-gray-900" id="subtotal">RM 0.00</span>
                    </div>
                    <div class="flex justify-between items-center mb-2" id="sstRow" style="display: none;">
                        <span class="text-gray-700">SST (6%):</span>
                        <span class="text-gray-700" id="sstAmount">RM 0.00</span>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-gray-300">
                        <span class="text-xl font-bold text-gray-900">Total Amount:</span>
                        <span class="text-xl font-bold text-green-600" id="totalAmount">RM 0.00</span>
                    </div>
                </div>
            </div>

            <!-- Quotation Details Form -->
            <form id="quotationForm" class="space-y-4">
                <input type="hidden" name="package_id" id="packageIdHidden">
                <input type="hidden" name="template_id" id="templateIdHidden">
                <input type="hidden" id="packagePrice" value="0">
                <input type="hidden" id="packageName" value="">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-gray-900">Customer Name</label>
                        <input 
                            type="text" 
                            name="customer_name" 
                            id="customerName"
                            class="w-full border-2 border-gray-300 rounded px-3 py-2 text-gray-900 bg-white focus:border-blue-500 focus:outline-none"
                            placeholder="Optional - leave blank for 'Sample Quotation'"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-gray-900">Customer Phone</label>
                        <input 
                            type="text" 
                            name="customer_phone" 
                            id="customerPhone"
                            class="w-full border-2 border-gray-300 rounded px-3 py-2 text-gray-900 bg-white focus:border-blue-500 focus:outline-none"
                            placeholder="e.g., 60123456789"
                        >
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-900">Customer Address</label>
                    <textarea 
                        name="customer_address" 
                        id="customerAddress"
                        rows="3"
                        class="w-full border-2 border-gray-300 rounded px-3 py-2 text-gray-900 bg-white focus:border-blue-500 focus:outline-none"
                        placeholder="Optional"
                    ></textarea>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-900">Discount Given</label>
                    <input 
                        type="text" 
                        name="discount_given" 
                        id="discountGiven"
                        class="w-full border-2 border-gray-300 rounded px-3 py-2 text-gray-900 bg-white focus:border-blue-500 focus:outline-none"
                        placeholder="e.g., '500 10%' for RM500 fixed + 10% discount"
                    >
                    <p class="text-xs text-gray-600 mt-1">Format: Fixed amount and/or percentage (e.g., "500 10%" or "500" or "10%")</p>
                </div>

                <!-- Hybrid Inverter Setup -->
                <div class="bg-indigo-50 p-4 rounded-lg border-2 border-indigo-200">
                    <h2 class="font-bold text-lg mb-3 text-gray-900">Hybrid Inverter Setup</h2>
                    <div class="space-y-4">
                        <!-- Item 1: SAJ Microinverter M2 1.8K -->
                        <div class="flex justify-between items-center bg-white p-3 rounded border border-indigo-100 shadow-sm">
                            <div class="flex-1">
                                <div class="text-sm font-semibold text-gray-900">SAJ Microinverter M2 1.8K</div>
                                <div class="text-xs text-gray-600">RM 1,000.00 each</div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button type="button" class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-700 font-bold hover:bg-indigo-200 flex items-center justify-center transition-colors" onclick="updateExtraItemQty('inverter_1.8k', -1)">-</button>
                                <span class="w-8 text-center font-bold text-gray-900" id="qty_inverter_1.8k">0</span>
                                <button type="button" class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-700 font-bold hover:bg-indigo-200 flex items-center justify-center transition-colors" onclick="updateExtraItemQty('inverter_1.8k', 1)">+</button>
                            </div>
                        </div>
                        <!-- Item 2: SAJ Microinverter M2 1.0K -->
                         <div class="flex justify-between items-center bg-white p-3 rounded border border-indigo-100 shadow-sm">
                            <div class="flex-1">
                                <div class="text-sm font-semibold text-gray-900">SAJ Microinverter M2 1.0K</div>
                                <div class="text-xs text-gray-600">RM 500.00 each</div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button type="button" class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-700 font-bold hover:bg-indigo-200 flex items-center justify-center transition-colors" onclick="updateExtraItemQty('inverter_1.0k', -1)">-</button>
                                <span class="w-8 text-center font-bold text-gray-900" id="qty_inverter_1.0k">0</span>
                                <button type="button" class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-700 font-bold hover:bg-indigo-200 flex items-center justify-center transition-colors" onclick="updateExtraItemQty('inverter_1.0k', 1)">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Voucher Section -->
                <div class="bg-green-50 p-4 rounded-lg border-2 border-green-200">
                    <label class="block text-sm font-semibold mb-2 text-gray-900">Vouchers</label>
                    <div class="flex gap-2 mb-3">
                        <select 
                            id="voucherSelectDropdown"
                            class="flex-1 min-w-0 border-2 border-gray-300 rounded px-3 py-2 text-gray-900 bg-white focus:border-green-500 focus:outline-none"
                        >
                            <option value="">-- Select a Voucher --</option>
                        </select>
                        <button 
                            type="button" 
                            id="addVoucherBtn"
                            class="bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded shadow-sm transition-colors"
                        >
                            Add
                        </button>
                    </div>
                    
                    <!-- Selected Vouchers List -->
                    <div id="selectedVouchersContainer" class="hidden space-y-2 mb-2">
                        <h4 class="text-xs font-semibold text-green-800 uppercase tracking-wide">Applied Vouchers:</h4>
                        <div id="selectedVouchersList" class="space-y-2">
                            <!-- Items populated by JS -->
                        </div>
                    </div>

                    <!-- Voucher Info Preview (for currently selected item in dropdown) -->
                    <div id="voucherInfo" class="hidden mt-2 p-3 bg-white rounded border border-green-100 shadow-sm">
                        <p class="text-sm font-semibold text-green-800" id="voucherTitle"></p>
                        <p class="text-xs text-green-700 mt-1" id="voucherDesc"></p>
                        <p class="text-xs text-green-600 mt-1 italic" id="voucherTerms"></p>
                    </div>
                </div>

                <!-- SST Toggle (default: OFF) -->
                <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
                    <input 
                        type="checkbox" 
                        name="apply_sst" 
                        id="applySST" 
                        class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500"
                    >
                    <label for="applySST" class="text-sm font-semibold text-gray-900">Apply 6% SST (Sales & Service Tax)</label>
                </div>

                <!-- Payment Methods Section -->
                <div class="bg-purple-50 p-4 rounded-lg border-2 border-purple-300">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-lg text-gray-900">Payment Methods</h2>
                        <button 
                            type="button" 
                            id="addPaymentMethodBtn"
                            class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold px-4 py-2 rounded shadow-md transition-colors"
                        >
                            + Add Payment Method
                        </button>
                    </div>
                    <div id="paymentMethodsContainer" class="space-y-4">
                        <!-- Payment method rows will be added here -->
                    </div>
                    <div id="paymentSummary" class="mt-4 pt-4 border-t border-purple-200">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-semibold text-gray-700">Effective Payment:</span>
                            <span class="text-sm font-semibold text-gray-900" id="totalPaymentAmount">RM 0.00 (0%)</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-semibold text-gray-700">Unpaid Balance:</span>
                            <span class="text-sm font-semibold text-red-600" id="unpaidBalanceAmount">RM 0.00 (100%)</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-semibold text-gray-700">Total EPP Fees:</span>
                            <span class="text-sm font-semibold text-purple-700" id="totalEPPFees">RM 0.00</span>
                        </div>
                    </div>
                </div>

                <div class="flex gap-4 pt-4">
                    <button 
                        type="submit" 
                        class="bg-green-600 hover:bg-green-700 text-white font-semibold px-8 py-3 rounded-lg shadow-md transition-colors"
                    >
                        Save New Version
                    </button>
                    <a 
                        href="/my-invoice" 
                        class="bg-gray-600 hover:bg-gray-700 text-white font-semibold px-8 py-3 rounded-lg shadow-md transition-colors inline-flex items-center"
                    >
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>

    <script>
        // EPP Rate Configuration
        const EPP_RATES = {
            "Maybank": { 6: 2.50, 12: 3.50, 24: 5.50, 36: 6.00, 48: 8.00, 60: 10.00 },
            "Public Bank": { 6: 2.50, 12: 3.50, 18: 4.00, 24: 5.50, 36: 6.00, 48: 8.00, 60: 10.00 },
            "Hong Leong Bank": { 12: 3.50, 24: 5.50, 36: 6.00, 48: 8.00, 60: 10.00 },
            "CIMB": { 6: 2.50, 12: 3.50 },
            "AM Bank": { 24: 7.00, 36: 9.00 },
            "UOB": { 6: 2.50, 12: 3.50, 24: 5.50, 48: 8.50, 68: 11.50 },
            "OCBC": { 6: 4.00, 12: 5.00, 18: 6.00, 24: 7.00, 36: 8.00, 48: 9.00 }
        };

        const BANKS = Object.keys(EPP_RATES);
        let paymentMethodCounter = 0;
        let availableVouchers = [];
        let selectedVouchers = [];

        // Extra Items Configuration
        const EXTRA_ITEMS_CONFIG = {
            'inverter_1.8k': { name: 'SAJ Microinverter M2 1.8K', price: 1000.00 },
            'inverter_1.0k': { name: 'SAJ Microinverter M2 1.0K', price: 500.00 }
        };
        const extraItemsState = {
            'inverter_1.8k': 0,
            'inverter_1.0k': 0
        };

        // Always in edit mode for this page
        window.isEditMode = true;
        window.editInvoiceId = null;
        window.currentAgentMarkup = 0;

        // Update extra item quantity
        window.updateExtraItemQty = function(id, delta) {
            if (!extraItemsState.hasOwnProperty(id)) return;
            const newQty = Math.max(0, extraItemsState[id] + delta);
            extraItemsState[id] = newQty;
            const qtyEl = document.getElementById(`qty_${id}`);
            if (qtyEl) qtyEl.textContent = newQty;
            updateInvoicePreview();
        };

        // Fetch available vouchers
        async function fetchVouchers() {
            try {
                const response = await fetch('/api/vouchers');
                const result = await response.json();
                
                if (result.success) {
                    availableVouchers = result.vouchers;
                    populateVoucherSelect();
                }
            } catch (err) {
                console.error('Error fetching vouchers:', err);
            }
        }

        // Populate voucher dropdown
        function populateVoucherSelect() {
            const select = document.getElementById('voucherSelectDropdown');
            if (!select) return;
            
            // Keep first option
            select.innerHTML = '<option value="">-- Select a Voucher --</option>';
            
            availableVouchers.forEach(v => {
                const option = document.createElement('option');
                option.value = v.voucher_code;
                let text = v.title || v.voucher_code;
                if (v.discount_amount) text += ` (RM ${v.discount_amount})`;
                if (v.discount_percent) text += ` (${v.discount_percent}%)`;
                option.textContent = text;
                select.appendChild(option);
            });
        }

        // Get currently previewed voucher (in dropdown)
        function getPreviewVoucher() {
            const select = document.getElementById('voucherSelectDropdown');
            if (!select || !select.value) return null;
            return availableVouchers.find(v => v.voucher_code === select.value) || null;
        }

        // Add voucher to selection
        function addVoucher() {
            const voucher = getPreviewVoucher();
            if (!voucher) return;

            // Check if already added
            if (selectedVouchers.find(v => v.voucher_code === voucher.voucher_code)) {
                alert('This voucher is already added.');
                return;
            }
            
            selectedVouchers.push(voucher);
            renderSelectedVouchers();
            updateInvoicePreview();
            
            // Reset dropdown
            const select = document.getElementById('voucherSelectDropdown');
            if (select) select.value = "";
            updateVoucherInfo();
        }

        // Remove voucher from selection
        function removeVoucher(code) {
            selectedVouchers = selectedVouchers.filter(v => v.voucher_code !== code);
            renderSelectedVouchers();
            updateInvoicePreview();
        }

        // Render selected vouchers list
        function renderSelectedVouchers() {
            const container = document.getElementById('selectedVouchersContainer');
            const list = document.getElementById('selectedVouchersList');
            if (!container || !list) return;

            if (selectedVouchers.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            list.innerHTML = '';

            selectedVouchers.forEach(v => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-white p-2 rounded border border-green-200 shadow-sm';
                
                let valText = '';
                if (v.discount_amount) valText = `RM ${v.discount_amount}`;
                else if (v.discount_percent) valText = `${v.discount_percent}%`;

                item.innerHTML = `
                    <div class="flex-1">
                        <div class="text-sm font-semibold text-gray-900">${v.title || v.voucher_code}</div>
                        <div class="text-xs text-gray-600">${v.invoice_description || ''}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-sm font-bold text-green-600">${valText}</span>
                        <button type="button" class="text-red-500 hover:text-red-700 p-1" onclick="removeVoucher('${v.voucher_code}')" title="Remove">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // Update voucher info display (dropdown preview)
        function updateVoucherInfo() {
            const voucher = getPreviewVoucher();
            const infoDiv = document.getElementById('voucherInfo');
            const titleEl = document.getElementById('voucherTitle');
            const descEl = document.getElementById('voucherDesc');
            const termsEl = document.getElementById('voucherTerms');
            
            if (voucher) {
                infoDiv.classList.remove('hidden');
                titleEl.textContent = voucher.title || voucher.voucher_code;
                descEl.textContent = voucher.invoice_description || '';
                termsEl.textContent = voucher.terms_conditions || '';
            } else {
                infoDiv.classList.add('hidden');
            }
        }

        // Parse discount string (same logic as backend)
        function parseDiscount(discountStr) {
            if (!discountStr || !discountStr.trim()) {
                return { fixed: 0, percent: 0 };
            }
            
            let discountFixed = 0;
            let discountPercent = 0;
            
            const parts = discountStr.trim().replace('+', ' ').split(/\s+/);
            
            for (let part of parts) {
                part = part.trim();
                if (part.includes('%')) {
                    discountPercent = parseFloat(part.replace('%', '')) || 0;
                } else {
                    const value = parseFloat(part.replace(/RM|,/g, '')) || 0;
                    if (value > 0) {
                        discountFixed = value;
                    }
                }
            }
            
            return { fixed: discountFixed, percent: discountPercent };
        }

        // Get available tenures for a bank
        function getAvailableTenures(bank) {
            if (!bank || !EPP_RATES[bank]) return [];
            return Object.keys(EPP_RATES[bank])
                .filter(t => t !== 'foreign_card')
                .map(t => parseInt(t))
                .sort((a, b) => a - b);
        }

        // Get EPP rate for bank and tenure
        function getEPPRate(bank, tenure) {
            if (!bank || !tenure || !EPP_RATES[bank]) return null;
            return EPP_RATES[bank][tenure] || null;
        }

        // Calculate EPP fee
        function calculateEPPFee(amount, bank, tenure) {
            const rate = getEPPRate(bank, tenure);
            if (!rate) return 0;
            return amount * (rate / 100);
        }

        // Format amount with commas
        function formatAmount(amount) {
            return amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // Create payment method row HTML
        function createPaymentMethodRow(index) {
            return `
                <div class="payment-method-row bg-white p-4 rounded border border-purple-200" data-index="${index}">
                    <div class="flex justify-between items-start mb-3">
                        <span class="font-semibold text-gray-900">Payment Method ${index + 1}:</span>
                        ${index > 0 ? `<button type="button" class="remove-payment-method text-red-600 hover:text-red-800 text-sm font-medium" data-index="${index}">Remove</button>` : ''}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                        <div>
                            <label class="block text-xs font-semibold mb-1 text-gray-700">Method</label>
                            <select class="payment-method w-full border-2 border-gray-300 rounded px-3 py-2 text-gray-900 bg-white focus:border-blue-500 focus:outline-none text-sm" data-index="${index}">
                                <option value="cash">Cash</option>
                                <option value="credit_card">Credit Card</option>
                                <option value="credit_card_epp">Credit Card EPP</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold mb-1 text-gray-700">Amount Type</label>
                            <select class="amount-type w-full border-2 border-gray-300 rounded px-3 py-2 text-gray-900 bg-white focus:border-blue-500 focus:outline-none text-sm" data-index="${index}">
                                <option value="percent">%</option>
                                <option value="amount">RM</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold mb-1 text-gray-700">Amount/Percentage</label>
                            <input 
                                type="number" 
                                step="0.01" 
                                min="0"
                                class="amount-value w-full border-2 border-gray-300 rounded px-3 py-2 text-gray-900 bg-white focus:border-blue-500 focus:outline-none text-sm" 
                                data-index="${index}"
                                placeholder="0.00"
                            >
                        </div>
                    </div>
                    <div class="epp-details hidden" data-index="${index}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="block text-xs font-semibold mb-1 text-gray-700">Bank</label>
                                <select class="epp-bank w-full border-2 border-gray-300 rounded px-3 py-2 text-gray-900 bg-white focus:border-blue-500 focus:outline-none text-sm" data-index="${index}">
                                    ${BANKS.map(bank => `<option value="${bank}">${bank}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold mb-1 text-gray-700">Tenure (Months)</label>
                                <select class="epp-tenure w-full border-2 border-gray-300 rounded px-3 py-2 text-gray-900 bg-white focus:border-blue-500 focus:outline-none text-sm" data-index="${index}">
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="epp-info text-sm text-gray-700 space-y-1">
                            <div class="epp-amount-info"></div>
                            <div class="epp-rate-info"></div>
                            <div class="epp-fee-info font-semibold text-purple-700"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Update tenure options based on selected bank
        function updateTenureOptions(index) {
            const row = document.querySelector(`.payment-method-row[data-index="${index}"]`);
            if (!row) return;
            
            const bankSelect = row.querySelector('.epp-bank');
            const tenureSelect = row.querySelector('.epp-tenure');
            
            if (!bankSelect || !tenureSelect) return;
            
            const bank = bankSelect.value;
            const tenures = getAvailableTenures(bank);
            
            tenureSelect.innerHTML = tenures.map(t => `<option value="${t}">${t} months</option>`).join('');
            
            // Trigger update
            updatePaymentMethodInfo(index);
        }

        // Update payment method info display
        function updatePaymentMethodInfo(index) {
            const row = document.querySelector(`.payment-method-row[data-index="${index}"]`);
            if (!row) return;
            
            const methodSelect = row.querySelector('.payment-method');
            const amountTypeSelect = row.querySelector('.amount-type');
            const amountValueInput = row.querySelector('.amount-value');
            const eppDetails = row.querySelector('.epp-details');
            const bankSelect = row.querySelector('.epp-bank');
            const tenureSelect = row.querySelector('.epp-tenure');
            const amountInfo = row.querySelector('.epp-amount-info');
            const rateInfo = row.querySelector('.epp-rate-info');
            const feeInfo = row.querySelector('.epp-fee-info');
            
            const method = methodSelect.value;
            const isEPP = method === 'credit_card_epp';
            
            // Show/hide EPP details
            if (eppDetails) {
                eppDetails.classList.toggle('hidden', !isEPP);
            }
            
            if (!isEPP) return;
            
            const bank = bankSelect?.value;
            const tenure = tenureSelect ? parseInt(tenureSelect.value) : null;
            const amountType = amountTypeSelect?.value;
            const amountValue = parseFloat(amountValueInput?.value || 0);
            
            // Calculate package price after discount and voucher
            const packagePrice = parseFloat(document.getElementById('packagePrice')?.value || 0);
            const discountInput = document.getElementById('discountGiven')?.value || '';
            const discount = parseDiscount(discountInput);
            
            // Calculate total voucher amount
            let totalVoucherAmount = 0;
            selectedVouchers.forEach(voucher => {
                let amount = 0;
                if (voucher.discount_amount) {
                    amount = parseFloat(voucher.discount_amount);
                } else if (voucher.discount_percent) {
                    amount = packagePrice * (parseFloat(voucher.discount_percent) / 100);
                }
                totalVoucherAmount += amount;
            });

            // Calculate extra items total
            let extraItemsTotal = 0;
            Object.keys(extraItemsState).forEach(key => {
                const qty = extraItemsState[key];
                if (qty > 0) {
                    extraItemsTotal += qty * EXTRA_ITEMS_CONFIG[key].price;
                }
            });

            let subtotalAfterDiscount = packagePrice + extraItemsTotal;
            if (discount.fixed > 0) subtotalAfterDiscount -= discount.fixed;
            if (discount.percent > 0) subtotalAfterDiscount -= (packagePrice * discount.percent / 100);
            subtotalAfterDiscount -= totalVoucherAmount; // Deduct vouchers

            if (subtotalAfterDiscount < 0) subtotalAfterDiscount = 0;
            
            // Calculate EPP amount
            let eppAmount = 0;
            if (amountType === 'percent') {
                eppAmount = subtotalAfterDiscount * (amountValue / 100);
            } else {
                eppAmount = amountValue;
            }
            
            // Get rate and calculate fee
            const rate = getEPPRate(bank, tenure);
            const fee = rate ? calculateEPPFee(eppAmount, bank, tenure) : 0;
            
            // Update info display
            if (amountInfo) {
                amountInfo.textContent = `Amount: RM ${formatAmount(eppAmount)}`;
            }
            if (rateInfo && rate) {
                rateInfo.textContent = `Rate: ${rate}%`;
            } else if (rateInfo) {
                rateInfo.textContent = `Rate: Not available`;
            }
            if (feeInfo) {
                feeInfo.textContent = `Estimated Fee: RM ${formatAmount(fee)}`;
            }
        }

        // Calculate all EPP fees and create description
        function calculateAllEPPFees() {
            // Calculate package price after discount and voucher
            const packagePrice = parseFloat(document.getElementById('packagePrice')?.value || 0);
            const discountInput = document.getElementById('discountGiven')?.value || '';
            const discount = parseDiscount(discountInput);
            
            // Calculate total voucher amount
            let totalVoucherAmount = 0;
            selectedVouchers.forEach(voucher => {
                let amount = 0;
                if (voucher.discount_amount) {
                    amount = parseFloat(voucher.discount_amount);
                } else if (voucher.discount_percent) {
                    amount = packagePrice * (parseFloat(voucher.discount_percent) / 100);
                }
                totalVoucherAmount += amount;
            });

            // Calculate extra items total
            let extraItemsTotal = 0;
            Object.keys(extraItemsState).forEach(key => {
                const qty = extraItemsState[key];
                if (qty > 0) {
                    extraItemsTotal += qty * EXTRA_ITEMS_CONFIG[key].price;
                }
            });

            let subtotalAfterDiscount = packagePrice + extraItemsTotal;
            if (discount.fixed > 0) subtotalAfterDiscount -= discount.fixed;
            if (discount.percent > 0) subtotalAfterDiscount -= (packagePrice * discount.percent / 100);
            subtotalAfterDiscount -= totalVoucherAmount; // Deduct vouchers

            if (subtotalAfterDiscount < 0) subtotalAfterDiscount = 0;

            const rows = document.querySelectorAll('.payment-method-row');
            const eppTransactions = [];
            const allPayments = [];
            let totalEPPFee = 0;
            let totalPayment = 0;
            
            rows.forEach((row, index) => {
                const methodSelect = row.querySelector('.payment-method');
                const amountTypeSelect = row.querySelector('.amount-type');
                const amountValueInput = row.querySelector('.amount-value');
                const bankSelect = row.querySelector('.epp-bank');
                const tenureSelect = row.querySelector('.epp-tenure');
                
                if (!methodSelect || !amountTypeSelect || !amountValueInput) return;
                
                const method = methodSelect.value;
                const amountType = amountTypeSelect.value;
                const amountValue = parseFloat(amountValueInput.value || 0);
                
                if (amountValue <= 0) return;
                
                // Calculate payment amount
                let paymentAmount = 0;
                if (amountType === 'percent') {
                    paymentAmount = subtotalAfterDiscount * (amountValue / 100);
                } else {
                    paymentAmount = amountValue;
                }
                
                totalPayment += paymentAmount;
                
                // Store payment info for structure notice
                let methodLabel = method === 'cash' ? 'Cash' : (method === 'credit_card' ? 'Credit Card' : 'Credit Card EPP');
                if (method === 'credit_card_epp' && bankSelect && tenureSelect) {
                    methodLabel = `${bankSelect.value} ${tenureSelect.value}mths`;
                }
                allPayments.push(`Payment ${allPayments.length + 1}: RM ${formatAmount(paymentAmount)} (${methodLabel})`);
                
                // If EPP, calculate fee
                if (method === 'credit_card_epp' && bankSelect && tenureSelect) {
                    const bank = bankSelect.value;
                    const tenure = parseInt(tenureSelect.value);
                    const rate = getEPPRate(bank, tenure);
                    
                    if (rate) {
                        const fee = calculateEPPFee(paymentAmount, bank, tenure);
                        totalEPPFee += fee;
                        eppTransactions.push({
                            bank: bank,
                            tenure: tenure,
                            amount: paymentAmount
                        });
                    }
                }
            });
            
            // Format EPP fee description for the "Bank Processing Fee" item
            let description = '';
            if (eppTransactions.length > 0) {
                description = eppTransactions.map(t => 
                    `${t.bank} EPP ${t.tenure} Months - RM${Math.round(t.amount)}`
                ).join(', ');
            }
            
            return {
                total_fee: totalEPPFee,
                description: description,
                total_payment: totalPayment,
                payment_structure: allPayments.join(' | ')
            };
        }

        // Add payment method row
        function addPaymentMethodRow() {
            const container = document.getElementById('paymentMethodsContainer');
            if (!container) return;
            
            const index = paymentMethodCounter++;
            const rowHTML = createPaymentMethodRow(index);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = rowHTML;
            const row = tempDiv.firstElementChild;
            
            container.appendChild(row);
            
            // Initialize tenure options for EPP
            if (index === 0) {
                // Set default for first row: Cash, 100%
                const methodSelect = row.querySelector('.payment-method');
                const amountTypeSelect = row.querySelector('.amount-type');
                const amountValueInput = row.querySelector('.amount-value');
                if (methodSelect) methodSelect.value = 'cash';
                if (amountTypeSelect) amountTypeSelect.value = 'percent';
                if (amountValueInput) amountValueInput.value = '100';
            } else {
                // For new rows, initialize tenure if EPP
                updateTenureOptions(index);
            }
            
            // Attach event listeners
            attachPaymentMethodListeners(row, index);
            updateInvoicePreview();
        }

        // Remove payment method row
        function removePaymentMethodRow(index) {
            const row = document.querySelector(`.payment-method-row[data-index="${index}"]`);
            if (row) {
                row.remove();
                updateInvoicePreview();
            }
        }

        // Attach event listeners to payment method row
        function attachPaymentMethodListeners(row, index) {
            const methodSelect = row.querySelector('.payment-method');
            const amountTypeSelect = row.querySelector('.amount-type');
            const amountValueInput = row.querySelector('.amount-value');
            const bankSelect = row.querySelector('.epp-bank');
            const tenureSelect = row.querySelector('.epp-tenure');
            const removeBtn = row.querySelector('.remove-payment-method');
            
            if (methodSelect) {
                methodSelect.addEventListener('change', () => {
                    updatePaymentMethodInfo(index);
                    updateInvoicePreview();
                });
            }
            
            if (amountTypeSelect) {
                amountTypeSelect.addEventListener('change', () => {
                    updatePaymentMethodInfo(index);
                    updateInvoicePreview();
                });
            }
            
            if (amountValueInput) {
                amountValueInput.addEventListener('input', () => {
                    updatePaymentMethodInfo(index);
                    updateInvoicePreview();
                });
            }
            
            if (bankSelect) {
                bankSelect.addEventListener('change', () => {
                    updateTenureOptions(index);
                    updatePaymentMethodInfo(index);
                    updateInvoicePreview();
                });
            }
            
            if (tenureSelect) {
                tenureSelect.addEventListener('change', () => {
                    updatePaymentMethodInfo(index);
                    updateInvoicePreview();
                });
            }
            
            if (removeBtn) {
                removeBtn.addEventListener('click', () => {
                    removePaymentMethodRow(index);
                });
            }
        }

        // Update invoice items preview
        function updateInvoicePreview() {
            const packagePrice = parseFloat(document.getElementById('packagePrice')?.value || 0);
            const discountInput = document.getElementById('discountGiven')?.value || '';
            const discount = parseDiscount(discountInput);
            
            const itemsList = document.getElementById('quotationItemsList');
            if (!itemsList) return;
            
            // Clear existing items
            itemsList.innerHTML = '';
            
            // Add package item
            const packageName = document.getElementById('packageName')?.value || 'Package Item';
            const packageItem = document.createElement('div');
            packageItem.className = 'flex justify-between items-center py-2 border-b border-gray-200';
            packageItem.innerHTML = `
                <div class="flex-1">
                    <div class="font-medium text-gray-900">${packageName}</div>
                    <div class="text-sm text-gray-600">1 × RM ${packagePrice.toFixed(2)}</div>
                </div>
                <div class="font-semibold text-gray-900">RM ${packagePrice.toFixed(2)}</div>
            `;
            itemsList.appendChild(packageItem);
            
            // Calculate subtotal (starting with package price)
            let subtotal = packagePrice;

            // Add Extra Items
            Object.keys(extraItemsState).forEach(key => {
                const qty = extraItemsState[key];
                if (qty > 0) {
                    const config = EXTRA_ITEMS_CONFIG[key];
                    const itemTotal = qty * config.price;
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center py-2 border-b border-gray-200';
                    item.innerHTML = `
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">${config.name}</div>
                            <div class="text-sm text-gray-600">${qty} × RM ${config.price.toFixed(2)}</div>
                        </div>
                        <div class="font-semibold text-gray-900">RM ${itemTotal.toFixed(2)}</div>
                    `;
                    itemsList.appendChild(item);
                    subtotal += itemTotal;
                }
            });
            
            // Add fixed discount item if exists
            if (discount.fixed > 0) {
                const fixedDiscountItem = document.createElement('div');
                fixedDiscountItem.className = 'flex justify-between items-center py-2 border-b border-gray-200';
                fixedDiscountItem.innerHTML = `
                    <div class="flex-1">
                        <div class="font-medium text-red-600">Discount (RM ${discount.fixed.toFixed(2)})</div>
                    </div>
                    <div class="font-semibold text-red-600">-RM ${discount.fixed.toFixed(2)}</div>
                `;
                itemsList.appendChild(fixedDiscountItem);
                subtotal -= discount.fixed;
            }
            
            // Add percentage discount item if exists
            if (discount.percent > 0) {
                const percentAmount = packagePrice * (discount.percent / 100);
                const percentDiscountItem = document.createElement('div');
                percentDiscountItem.className = 'flex justify-between items-center py-2 border-b border-gray-200';
                percentDiscountItem.innerHTML = `
                    <div class="flex-1">
                        <div class="font-medium text-red-600">Discount (${discount.percent}%)</div>
                    </div>
                    <div class="font-semibold text-red-600">-RM ${percentAmount.toFixed(2)}</div>
                `;
                itemsList.appendChild(percentDiscountItem);
                subtotal -= percentAmount;
            }
            
            // Add Voucher Items
            selectedVouchers.forEach(voucher => {
                let voucherAmount = 0;
                if (voucher.discount_amount) {
                    voucherAmount = parseFloat(voucher.discount_amount);
                } else if (voucher.discount_percent) {
                    voucherAmount = packagePrice * (parseFloat(voucher.discount_percent) / 100);
                }
                
                if (voucherAmount > 0) {
                     const voucherItem = document.createElement('div');
                    voucherItem.className = 'flex justify-between items-center py-2 border-b border-gray-200';
                    voucherItem.innerHTML = `
                        <div class="flex-1">
                            <div class="font-medium text-green-600">${voucher.title || 'Voucher'} (${voucher.voucher_code})</div>
                        </div>
                        <div class="font-semibold text-green-600">-RM ${voucherAmount.toFixed(2)}</div>
                    `;
                    itemsList.appendChild(voucherItem);
                    subtotal -= voucherAmount;
                }
            });

            // Ensure subtotal doesn't go negative
            if (subtotal < 0) subtotal = 0;
            
            // Store subtotal after discount for payment calculation
            const subtotalAfterDiscount = subtotal;
            
            // Calculate EPP fees
            const eppData = calculateAllEPPFees();
            
            // Add EPP fee item if exists
            if (eppData.total_fee > 0 && eppData.description) {
                const eppFeeItem = document.createElement('div');
                eppFeeItem.className = 'flex justify-between items-center py-2 border-b border-gray-200';
                eppFeeItem.innerHTML = `
                    <div class="flex-1">
                        <div class="font-medium text-purple-700">Bank Processing Fee</div>
                        <div class="text-sm text-gray-600">${eppData.description}</div>
                    </div>
                    <div class="font-semibold text-purple-700">RM ${eppData.total_fee.toFixed(2)}</div>
                `;
                itemsList.appendChild(eppFeeItem);
                subtotal += eppData.total_fee;
            }
            
            // Update payment summary
            const totalPaymentDisplay = document.getElementById('totalPaymentAmount');
            const unpaidBalanceDisplay = document.getElementById('unpaidBalanceAmount');
            const totalEPPFeesDisplay = document.getElementById('totalEPPFees');
            
            if (totalPaymentDisplay) {
                const paymentPercent = subtotalAfterDiscount > 0 ? (eppData.total_payment / subtotalAfterDiscount * 100) : 0;
                totalPaymentDisplay.textContent = `RM ${formatAmount(eppData.total_payment)} (${paymentPercent.toFixed(2)}%)`;
                
                if (Math.abs(paymentPercent - 100) < 0.01) {
                    totalPaymentDisplay.classList.add('text-green-600');
                    totalPaymentDisplay.classList.remove('text-red-600');
                } else {
                    totalPaymentDisplay.classList.add('text-red-600');
                    totalPaymentDisplay.classList.remove('text-green-600');
                }

                // Calculate and display Unpaid Balance
                if (unpaidBalanceDisplay) {
                    const unpaidAmount = Math.max(0, subtotalAfterDiscount - eppData.total_payment);
                    const unpaidPercent = Math.max(0, 100 - paymentPercent);
                    
                    unpaidBalanceDisplay.textContent = `RM ${formatAmount(unpaidAmount)} (${unpaidPercent.toFixed(2)}%)`;
                    
                    if (unpaidAmount < 0.01) {
                         unpaidBalanceDisplay.classList.add('text-green-600');
                         unpaidBalanceDisplay.classList.remove('text-red-600');
                    } else {
                         unpaidBalanceDisplay.classList.add('text-red-600');
                         unpaidBalanceDisplay.classList.remove('text-green-600');
                    }
                }
            }
            if (totalEPPFeesDisplay) {
                totalEPPFeesDisplay.textContent = `RM ${formatAmount(eppData.total_fee)}`;
            }
            
            // Calculate SST (6%)
            const applySST = document.getElementById('applySST')?.checked || false;
            const sstRate = applySST ? 6.0 : 0.0;
            const sstAmount = applySST ? (subtotal * (sstRate / 100)) : 0;
            const totalAmount = subtotal + sstAmount;
            
            // Update totals
            document.getElementById('subtotal').textContent = `RM ${subtotal.toFixed(2)}`;
            const sstLabel = document.querySelector('label[for="applySST"]');
            if (sstLabel) sstLabel.textContent = `Apply 6% SST (Sales & Service Tax)${applySST ? ' - RM ' + sstAmount.toFixed(2) : ''}`;
            
            // Show/hide SST row based on checkbox
            const sstRow = document.getElementById('sstRow');
            const sstAmountElement = document.getElementById('sstAmount');
            if (sstRow) {
                sstRow.style.display = applySST ? 'flex' : 'none';
            }
            if (sstAmountElement) {
                sstAmountElement.textContent = `RM ${sstAmount.toFixed(2)}`;
            }
            document.getElementById('totalAmount').textContent = `RM ${totalAmount.toFixed(2)}`;
        }

        // Load invoice data on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Fetch User Profile
            fetchUserProfile();

            // Get edit_invoice_id from URL
            const urlParams = new URLSearchParams(window.location.search);
            const editInvoiceId = urlParams.get('id');

            if (!editInvoiceId) {
                showError('No invoice ID provided. Please return to My Quotations page.');
                return;
            }

            window.editInvoiceId = editInvoiceId;
            
            // Show loading warning
            document.getElementById('warningMessage').classList.remove('hidden');
            document.getElementById('warningText').textContent = 'Loading quotation data...';

            try {
                // Fetch invoice data
                const res = await fetch(`/api/v1/invoices/${editInvoiceId}`);
                const json = await res.json();
                
                if (json.success && json.data) {
                    const inv = json.data;
                    
                    // Hide loading warning
                    document.getElementById('warningMessage').classList.add('hidden');
                    
                    // 1. Load Package
                    if (inv.package_id) {
                        await fetchPackageDetails(inv.package_id);
                    }
                    
                    // 2. Pre-fill Customer Info
                    if (inv.customer_name_snapshot) document.getElementById('customerName').value = inv.customer_name_snapshot;
                    if (inv.customer_phone_snapshot) document.getElementById('customerPhone').value = inv.customer_phone_snapshot;
                    if (inv.customer_address_snapshot) document.getElementById('customerAddress').value = inv.customer_address_snapshot;
                    
                    // 3. Discount
                    let discountVal = '';
                    if (inv.discount_fixed > 0) discountVal += inv.discount_fixed;
                    if (inv.discount_percent > 0) discountVal += (discountVal ? ' ' : '') + `${inv.discount_percent}%`;
                    document.getElementById('discountGiven').value = discountVal;
                    
                    // 4. SST
                    if (inv.sst_amount > 0) document.getElementById('applySST').checked = true;
                    
                    // 5. Markup (Preserve)
                    window.currentAgentMarkup = inv.agent_markup || 0;

                    // 6. Extra Items (Microinverters)
                    if (inv.items) {
                        inv.items.forEach(item => {
                            if (item.item_type === 'extra') {
                                if (item.description.includes('1.8K')) {
                                    updateExtraItemQty('inverter_1.8k', parseFloat(item.qty));
                                } else if (item.description.includes('1.0K')) {
                                    updateExtraItemQty('inverter_1.0k', parseFloat(item.qty));
                                }
                            }
                        });
                    }
                    
                    // 7. Fetch vouchers
                    await fetchVouchers();
                    
                    // 8. Load Vouchers from column
                    if (inv.voucher_code) {
                        const codes = inv.voucher_code.split(',').map(s => s.trim());
                        
                        codes.forEach(code => {
                            const v = availableVouchers.find(av => av.voucher_code === code);
                            if (v && !selectedVouchers.find(sv => sv.voucher_code === v.voucher_code)) {
                                selectedVouchers.push(v);
                            }
                        });
                        renderSelectedVouchers();
                    }

                    // 9. Trigger preview update
                    updateInvoicePreview();
                    
                    // 10. Add first payment method row (default: Cash, 100%)
                    addPaymentMethodRow();
                    
                } else {
                    showError('Failed to load invoice for editing. Invoice not found.');
                    document.getElementById('warningMessage').classList.add('hidden');
                }
            } catch (err) {
                console.error(err);
                showError('Error loading invoice: ' + err.message);
                document.getElementById('warningMessage').classList.add('hidden');
            }

            // Voucher listeners
            const voucherSelect = document.getElementById('voucherSelectDropdown');
            if (voucherSelect) {
                voucherSelect.addEventListener('change', () => {
                    updateVoucherInfo();
                });
            }
            
            const addVoucherBtn = document.getElementById('addVoucherBtn');
            if (addVoucherBtn) {
                addVoucherBtn.addEventListener('click', addVoucher);
            }

            // Update preview when SST toggle changes
            const sstToggle = document.getElementById('applySST');
            if (sstToggle) {
                sstToggle.addEventListener('change', updateInvoicePreview);
            }
            
            // Update preview when discount input changes
            const discountInput = document.getElementById('discountGiven');
            if (discountInput) {
                discountInput.addEventListener('input', updateInvoicePreview);
                discountInput.addEventListener('change', updateInvoicePreview);
            }
            
            // Add payment method button
            const addBtn = document.getElementById('addPaymentMethodBtn');
            if (addBtn) {
                addBtn.addEventListener('click', addPaymentMethodRow);
            }
        });

        async function fetchUserProfile() {
            try {
                const response = await fetch('/api/user/me');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.user) {
                        const welcomeDiv = document.getElementById('userWelcome');
                        const nameSpan = document.getElementById('userNameDisplay');
                        
                        if (welcomeDiv && nameSpan) {
                            nameSpan.textContent = data.user.name || 'User';
                            welcomeDiv.classList.remove('hidden');
                        }
                    }
                }
            } catch (err) {
                console.error('Error fetching user profile:', err);
            }
        }

        async function fetchPackageDetails(packageId) {
            try {
                const response = await fetch(`/api/package/${packageId}`);
                const result = await response.json();

                if (result.success && result.package) {
                    showPackage(result.package);
                } else {
                    showError(`Package Not Found: The Package ID '${packageId}' does not exist in database.`);
                }
            } catch (err) {
                console.error('Error fetching package:', err);
                showError(`Database Error: Failed to check package. Error: ${err.message}`);
            }
        }

        function showPackage(pkg) {
            const packageInfo = document.getElementById('quotationFormContainer');
            packageInfo.classList.remove('hidden');
            
            document.getElementById('packageNameDisplay').textContent = pkg.name || pkg.invoice_desc || `Package ${pkg.bubble_id}`;
            document.getElementById('packagePriceDisplay').textContent = `RM ${(parseFloat(pkg.price) || 0).toFixed(2)}`;
            
            document.getElementById('packagePrice').value = pkg.price || 0;
            document.getElementById('packageName').value = pkg.name || pkg.invoice_desc || `Package ${pkg.bubble_id}`;
            document.getElementById('packageIdHidden').value = pkg.bubble_id;
            
            if (pkg.invoice_desc) {
                const descContainer = document.getElementById('packageDescContainer');
                descContainer.classList.remove('hidden');
                document.getElementById('packageDescDisplay').textContent = pkg.invoice_desc;
            }
            
            updateInvoicePreview();
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.classList.remove('hidden');
            document.getElementById('errorText').textContent = message;
        }

        // Handle form submission
        document.getElementById('quotationForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            
            // Calculate EPP fees
            const eppData = calculateAllEPPFees();
            
            // Prepare extra items
            const extraItems = [];
            Object.keys(extraItemsState).forEach(key => {
                const qty = extraItemsState[key];
                if (qty > 0) {
                    const config = EXTRA_ITEMS_CONFIG[key];
                    extraItems.push({
                        description: config.name,
                        qty: qty,
                        unit_price: config.price,
                        total_price: qty * config.price
                    });
                }
            });

            // Prepare request data
            const requestData = {
                package_id: data.package_id,
                template_id: data.template_id || null,
                customer_name: data.customer_name || null,
                customer_phone: data.customer_phone || null,
                customer_address: data.customer_address || null,
                discount_given: data.discount_given || null,
                voucher_codes: selectedVouchers.map(v => v.voucher_code),
                apply_sst: document.getElementById('applySST')?.checked || false,
                payment_structure: eppData.payment_structure,
                extra_items: extraItems
            };
            
            // Add EPP fee data if exists
            if (eppData.total_fee > 0 && eppData.description) {
                requestData.epp_fee_amount = eppData.total_fee;
                requestData.epp_fee_description = eppData.description;
            }

            // Always use version endpoint for edit mode
            const endpoint = `/api/v1/invoices/${window.editInvoiceId}/version`;
            // Preserve markup
            requestData.agent_markup = window.currentAgentMarkup || 0;
            
            // Call the API
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    alert('Quotation updated successfully! New version saved with action logging.');
                    setTimeout(() => { window.location.href = '/my-invoice'; }, 1500);
                } else {
                    alert('Error: ' + (result.error || result.detail || 'Failed to process quotation'));
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            } catch (error) {
                alert('Error: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
    </script>
</body>
</html>
