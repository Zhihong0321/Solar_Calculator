<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Payment</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-3xl mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8 flex items-center gap-4">
            <a href="/my-invoice" id="backButton" class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            </a>
            <div>
                <h1 id="pageTitle" class="text-2xl font-bold text-gray-900">Submit Payment</h1>
                <p class="text-gray-600 mt-1">Upload proof of payment and details</p>
            </div>
        </div>

        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-gray-600">Loading invoice details...</p>
        </div>

        <div id="error" class="hidden bg-red-50 border-2 border-red-200 rounded-lg p-6 mb-6">
            <p class="text-red-800 font-semibold" id="errorMsg"></p>
        </div>

        <div id="content" class="hidden space-y-6">
            <!-- Invoice Summary -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-lg font-bold text-gray-900" id="invoiceNumber">INV-XXXXXX</h2>
                        <p class="text-sm text-gray-500" id="packageName">Package Name</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-500">Total Amount</p>
                        <p class="text-2xl font-bold text-blue-600" id="totalAmount">RM 0.00</p>
                    </div>
                </div>
                <div class="border-t pt-4 grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-gray-500 block">Customer</span>
                        <span class="font-medium" id="customerName">-</span>
                    </div>
                    <div>
                        <span class="text-gray-500 block">Date</span>
                        <span class="font-medium" id="invoiceDate">-</span>
                    </div>
                </div>
            </div>

            <!-- Payment Form -->
            <form id="paymentForm" class="bg-white rounded-lg shadow p-6 space-y-6">
                
                <!-- Method Selection -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Payment Method Type</label>
                    <div class="grid grid-cols-3 gap-3">
                        <label class="cursor-pointer">
                            <input type="radio" name="method" value="cash" class="peer sr-only" checked onchange="toggleSections()">
                            <div class="rounded-lg border-2 border-gray-200 p-4 text-center peer-checked:border-blue-600 peer-checked:bg-blue-50 hover:bg-gray-50">
                                <span class="block text-sm font-bold">Cash / Transfer</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="method" value="credit_card" class="peer sr-only" onchange="toggleSections()">
                            <div class="rounded-lg border-2 border-gray-200 p-4 text-center peer-checked:border-blue-600 peer-checked:bg-blue-50 hover:bg-gray-50">
                                <span class="block text-sm font-bold">Credit Card</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="method" value="epp" class="peer sr-only" onchange="toggleSections()">
                            <div class="rounded-lg border-2 border-gray-200 p-4 text-center peer-checked:border-blue-600 peer-checked:bg-blue-50 hover:bg-gray-50">
                                <span class="block text-sm font-bold">EPP Installment</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Cash/Card Bank Section -->
                <div id="generalBankSection" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Payment Bank</label>
                        <input type="text" name="paymentBank" id="paymentBank" placeholder="e.g. Maybank, CIMB" class="w-full border border-gray-300 rounded-lg p-2.5">
                        <p class="text-xs text-gray-500 mt-1">Enter the bank used for payment.</p>
                    </div>
                </div>

                <!-- EPP Section -->
                <div id="eppSection" class="hidden space-y-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h3 class="font-bold text-gray-800 border-b pb-2">EPP Details</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold uppercase text-gray-500 mb-1">EPP Bank</label>
                            <select id="eppBank" name="eppBank" class="w-full border-gray-300 rounded-lg p-2.5 text-sm" onchange="updateTenureOptions()">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Tenure (Months)</label>
                            <select id="eppTenure" name="eppTenure" class="w-full border-gray-300 rounded-lg p-2.5 text-sm">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Reference & Notes -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Payment Date</label>
                        <input type="date" name="paymentDate" id="paymentDate" required class="w-full border border-gray-300 rounded-lg p-2.5">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Reference No.</label>
                        <input type="text" name="referenceNo" placeholder="e.g. DUITNOW-123456" class="w-full border border-gray-300 rounded-lg p-2.5">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Notes</label>
                    <textarea name="notes" rows="2" class="w-full border border-gray-300 rounded-lg p-2.5" placeholder="Any additional details..."></textarea>
                </div>

                <!-- File Upload -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Proof of Payment</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition-colors relative" id="dropZone">
                        <input type="file" id="fileInput" accept="image/*,application/pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(event)">
                        <div id="filePreview" class="hidden mb-3">
                            <!-- Preview Image or Icon -->
                        </div>
                        <p class="text-sm text-gray-600" id="fileLabel">Click to upload or drag and drop</p>
                        <p class="text-xs text-gray-400 mt-1">Images or PDF (Max 2MB)</p>
                    </div>
                    <input type="hidden" name="proofFile" id="proofFileBase64">
                    <input type="hidden" name="fileName" id="fileName">
                    <input type="hidden" name="fileType" id="fileType">
                </div>

                <!-- Submit Button -->
                <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition-transform transform active:scale-95">
                    Submit Payment
                </button>
            </form>
        </div>
    </div>

    <script>
        // EPP Rates (Copied from app.js) - Used only for tenure dropdown population
        const EPP_RATES = {
            "Maybank": { 6: 2.50, 12: 3.50, 24: 5.50, 36: 6.00, 48: 8.00, 60: 10.00 },
            "Public Bank": { 6: 2.50, 12: 3.50, 18: 4.00, 24: 5.50, 36: 6.00, 48: 8.00, 60: 10.00 },
            "Hong Leong Bank": { 12: 3.50, 24: 5.50, 36: 6.00, 48: 8.00, 60: 10.00 },
            "CIMB": { 6: 2.50, 12: 3.50 },
            "AM Bank": { 24: 7.00, 36: 9.00 },
            "UOB": { 6: 2.50, 12: 3.50, 24: 5.50, 48: 8.50, 68: 11.50 },
            "OCBC": { 6: 4.00, 12: 5.00, 18: 6.00, 24: 7.00, 36: 8.00, 48: 9.00 }
        };

        let invoiceData = null;
        const urlParams = new URLSearchParams(window.location.search);
        const invoiceBubbleId = urlParams.get('id');
        const editPaymentId = urlParams.get('edit_payment_id');

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            if (!invoiceBubbleId && !editPaymentId) {
                showError('No invoice ID or Payment ID specified.');
                return;
            }

            // Update Back Button
            const backBtn = document.getElementById('backButton');
            if (backBtn && invoiceBubbleId) {
                backBtn.href = `/invoice-office?id=${invoiceBubbleId}`;
            }

            // Set default date to today
            document.getElementById('paymentDate').valueAsDate = new Date();

            try {
                // If editing, load payment first to get invoice ID
                if (editPaymentId) {
                    document.getElementById('pageTitle').textContent = 'Edit Submitted Payment';
                    document.getElementById('submitBtn').textContent = 'Update Payment';
                    await loadPaymentForEdit(editPaymentId);
                } else {
                    await loadInvoice(invoiceBubbleId);
                }
                
                initEPP();

            } catch (err) {
                showError(err.message);
            }
        });

        async function loadPaymentForEdit(paymentId) {
            const res = await fetch(`/api/v1/submitted-payments/${paymentId}`);
            const json = await res.json();
            if (!json.success) throw new Error(json.error);
            
            const p = json.data;
            
            // Load invoice details
            await loadInvoice(p.linked_invoice);

            // Populate Form
            // Map backend method (CASH, CREDIT CARD, EPP) to radio values (cash, credit_card, epp)
            let methodVal = 'cash';
            if (p.payment_method === 'CREDIT CARD') methodVal = 'credit_card';
            if (p.payment_method === 'EPP') methodVal = 'epp';

            document.querySelector(`input[name="method"][value="${methodVal}"]`).checked = true;
            toggleSections();

            document.getElementById('paymentDate').value = new Date(p.payment_date).toISOString().split('T')[0];
            document.querySelector('input[name="referenceNo"]').value = getRefFromRemark(p.remark) || ''; 
            document.querySelector('textarea[name="notes"]').value = getNoteFromRemark(p.remark) || '';
            
            if (methodVal === 'epp') {
                // Wait for EPP options to populate (handled by initEPP -> updateTenure -> but we need to wait/set value)
                // We'll set values after a short delay or manually trigger
                setTimeout(() => {
                    if (p.issuer_bank) document.getElementById('eppBank').value = p.issuer_bank;
                    updateTenureOptions(); // Refresh tenure list
                    if (p.epp_month) document.getElementById('eppTenure').value = p.epp_month;
                }, 500);
            } else {
                if (p.issuer_bank) document.getElementById('paymentBank').value = p.issuer_bank;
            }

            // Show existing proof notice
            const fileLabel = document.getElementById('fileLabel');
            fileLabel.innerHTML = `Current Proof: <a href="${(p.attachment && p.attachment[0]) || '#'}" target="_blank" class="text-blue-600 underline">View File</a><br><span class="text-xs text-gray-500">Upload new file to replace</span>`;
        }

        async function loadInvoice(id) {
            const res = await fetch(`/api/v1/invoices/${id}`);
            const data = await res.json();
            if (!data.success) throw new Error(data.error);
            invoiceData = data.data;
            renderInvoice(invoiceData);
        }

        function getRefFromRemark(remark) {
            if (!remark) return '';
            const match = remark.match(/\[Ref: (.*?)\]/);
            return match ? match[1] : '';
        }

        function getNoteFromRemark(remark) {
            if (!remark) return '';
            return remark.replace(/\[Ref: .*?\]/, '').trim();
        }

        function showError(msg) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('errorMsg').textContent = msg;
        }

        function renderInvoice(inv) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');

            document.getElementById('invoiceNumber').textContent = inv.invoice_number;
            document.getElementById('packageName').textContent = inv.package_name_snapshot || 'Unknown Package';
            document.getElementById('totalAmount').textContent = formatCurrency(inv.total_amount);
            document.getElementById('customerName').textContent = inv.customer_name_snapshot || '-';
            document.getElementById('invoiceDate').textContent = new Date(inv.invoice_date).toLocaleDateString('en-MY', { timeZone: 'Asia/Kuala_Lumpur', year: 'numeric', month: 'short', day: 'numeric' });
        }

        function formatCurrency(val) {
            return new Intl.NumberFormat('en-MY', { style: 'currency', currency: 'MYR' }).format(val);
        }

        function initEPP() {
            const bankSelect = document.getElementById('eppBank');
            bankSelect.innerHTML = Object.keys(EPP_RATES).map(k => `<option value="${k}">${k}</option>`).join('');
            updateTenureOptions();
        }

        function updateTenureOptions() {
            const bank = document.getElementById('eppBank').value;
            const tenureSelect = document.getElementById('eppTenure');
            const rates = EPP_RATES[bank] || {};
            const tenures = Object.keys(rates).sort((a,b) => parseInt(a)-parseInt(b));
            
            tenureSelect.innerHTML = tenures.map(t => `<option value="${t}">${t} Months</option>`).join('');
        }

        function toggleSections() {
            const method = document.querySelector('input[name="method"]:checked').value;
            const eppSection = document.getElementById('eppSection');
            const generalBankSection = document.getElementById('generalBankSection');

            if (method === 'epp') {
                eppSection.classList.remove('hidden');
                generalBankSection.classList.add('hidden');
            } else {
                eppSection.classList.add('hidden');
                generalBankSection.classList.remove('hidden');
            }
        }

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Handle PDF directly (no compression)
            if (file.type === 'application/pdf') {
                if (file.size > 2 * 1024 * 1024) { // 2MB limit for PDF
                    alert('PDF File is too large. Max 2MB. Please compress it manually.');
                    event.target.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    setFilePayload(e.target.result, file.name, file.type);
                    showPreview(null, file.name);
                };
                reader.readAsDataURL(file);
                return;
            }

            // Handle Images (Compress if needed)
            if (file.type.startsWith('image/')) {
                // If small enough, use directly
                if (file.size <= 2 * 1024 * 1024) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        setFilePayload(e.target.result, file.name, file.type);
                        showPreview(e.target.result, file.name);
                    };
                    reader.readAsDataURL(file);
                } else {
                    // Compress
                    try {
                        const compressedDataUrl = await compressImage(file);
                        setFilePayload(compressedDataUrl, file.name, 'image/jpeg'); // Always converts to jpeg
                        showPreview(compressedDataUrl, file.name + ' (Compressed)');
                    } catch (err) {
                        console.error('Compression failed:', err);
                        alert('Failed to process image. Please try a smaller file.');
                        event.target.value = '';
                    }
                }
            } else {
                alert('Unsupported file type. Please upload an Image or PDF.');
                event.target.value = '';
            }
        }

        function setFilePayload(data, name, type) {
            document.getElementById('proofFileBase64').value = data;
            document.getElementById('fileName').value = name;
            document.getElementById('fileType').value = type;
        }

        function showPreview(src, name) {
            const label = document.getElementById('fileLabel');
            label.textContent = name;
            label.classList.add('font-bold', 'text-blue-600');
            
            const preview = document.getElementById('filePreview');
            if (src) {
                preview.innerHTML = `<img src="${src}" class="h-32 mx-auto rounded object-contain">`;
                preview.classList.remove('hidden');
            } else {
                // PDF icon or generic
                preview.innerHTML = `
                    <div class="h-32 flex items-center justify-center bg-gray-100 rounded text-red-500">
                        <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                        <span class="ml-2 font-bold">PDF</span>
                    </div>`;
                preview.classList.remove('hidden');
            }
        }

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    img.src = e.target.result;
                };
                
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Max dimensions
                    const MAX_WIDTH = 1600;
                    const MAX_HEIGHT = 1600;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Export as JPEG with reduced quality
                    let quality = 0.7;
                    let dataUrl = canvas.toDataURL('image/jpeg', quality);
                    
                    // Simple check if it's still too big (approx base64 length)
                    while (dataUrl.length > 2.5 * 1024 * 1024 && quality > 0.1) {
                        quality -= 0.1;
                        dataUrl = canvas.toDataURL('image/jpeg', quality);
                    }
                    
                    resolve(dataUrl);
                };
                
                img.onerror = reject;
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Submitting...';

            try {
                const formData = new FormData(e.target);
                const method = formData.get('method');
                
                const payload = {
                    paymentId: editPaymentId || null, // Send ID if editing
                    method: method,
                    date: formData.get('paymentDate'),
                    referenceNo: formData.get('referenceNo'),
                    notes: formData.get('notes'),
                    proof: formData.get('proofFile') ? {
                        data: formData.get('proofFile'), 
                        name: formData.get('fileName'),
                        type: formData.get('fileType')
                    } : null,
                    paymentBank: method !== 'epp' ? formData.get('paymentBank') : null,
                    epp: method === 'epp' ? {
                        bank: formData.get('eppBank'),
                        tenure: formData.get('eppTenure')
                    } : null
                };

                // Use invoiceData.bubble_id which is reliable in both create and edit modes
                const targetInvoiceId = invoiceData ? invoiceData.bubble_id : (invoiceBubbleId || editPaymentId); 

                const res = await fetch(`/api/v1/invoices/${targetInvoiceId}/payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await res.json();
                if (!result.success) throw new Error(result.error);

                // Success
                alert('Payment submitted successfully!');
                window.location.href = `/invoice-office?id=${targetInvoiceId}`;

            } catch (err) {
                alert('Error: ' + err.message);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });
    </script>
</body>
</html>