<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Invoice</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
    <!-- Header -->
    <div class="bg-gray-800 text-white px-6 py-4">
      <h1 class="text-2xl font-bold">Create Invoice</h1>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="hidden mx-6 mt-6 p-4 bg-red-50 border-l-4 border-red-400 rounded-lg">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">Error</h3>
          <p class="text-sm text-red-700 mt-1" id="errorText"></p>
        </div>
      </div>
    </div>

    <!-- Warning Message -->
    <div id="warningMessage" class="hidden mx-6 mt-6 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-lg">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-yellow-800">Notice</h3>
          <p class="text-sm text-yellow-700 mt-1" id="warningText"></p>
        </div>
      </div>
    </div>

    <!-- Form -->
    <div class="px-6 py-8">
      <form id="invoiceForm" action="/api/v1/invoices/on-the-fly" method="POST" class="space-y-6">
        <!-- Package Information -->
        <div class="bg-gray-50 p-6 rounded-lg">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Package Information</h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="package_id" class="block text-sm font-medium text-gray-700 mb-2">
                Package ID <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="package_id"
                name="package_id"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Enter Package ID"
              >
              <p class="text-xs text-gray-500 mt-1">The bubble_id of the package</p>
            </div>

            <div>
              <label for="template_id" class="block text-sm font-medium text-gray-700 mb-2">
                Template ID
              </label>
              <input
                type="text"
                id="template_id"
                name="template_id"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Enter Template ID (optional)"
              >
              <p class="text-xs text-gray-500 mt-1">Leave blank to use default template</p>
            </div>
          </div>

          <div id="packageInfo" class="hidden mt-4 p-4 bg-blue-50 border border-blue-200 rounded-md">
            <h3 class="text-sm font-semibold text-blue-900 mb-2">Selected Package:</h3>
            <p class="text-sm text-blue-800"><strong>Name:</strong> <span id="packageName">N/A</span></p>
            <p class="text-sm text-blue-800"><strong>Price:</strong> RM <span id="packagePrice">0.00</span></p>
            <p class="text-sm text-blue-800"><strong>Type:</strong> <span id="packageType">N/A</span></p>
            <p id="packageDesc" class="hidden text-sm text-blue-800 mt-2"><strong>Description:</strong> <span id="packageDescText"></span></p>
          </div>
        </div>

        <!-- Customer Information -->
        <div class="bg-gray-50 p-6 rounded-lg">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Customer Information</h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="md:col-span-2">
              <label for="customer_name" class="block text-sm font-medium text-gray-700 mb-2">
                Customer Name
              </label>
              <input
                type="text"
                id="customer_name"
                name="customer_name"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Enter customer name"
              >
            </div>

            <div>
              <label for="customer_phone" class="block text-sm font-medium text-gray-700 mb-2">
                Phone Number
              </label>
              <input
                type="tel"
                id="customer_phone"
                name="customer_phone"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="+60 1-234-56789"
              >
            </div>

            <div>
              <label for="customer_address" class="block text-sm font-medium text-gray-700 mb-2">
                Address
              </label>
              <textarea
                id="customer_address"
                name="customer_address"
                rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Enter customer address"
              ></textarea>
            </div>
          </div>
        </div>

        <!-- Discount & Pricing -->
        <div class="bg-gray-50 p-6 rounded-lg">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Discount & Pricing</h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="discount_given" class="block text-sm font-medium text-gray-700 mb-2">
                Discount
              </label>
              <input
                type="text"
                id="discount_given"
                name="discount_given"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="500, 10%, or 500 10%"
              >
              <p class="text-xs text-gray-500 mt-1">Format: "500" for RM500, "10%" for 10%, or "500 10%" for both</p>
            </div>

            <div>
              <label for="voucher_code" class="block text-sm font-medium text-gray-700 mb-2">
                Voucher Code
              </label>
              <input
                type="text"
                id="voucher_code"
                name="voucher_code"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Enter voucher code (optional)"
              >
            </div>

            <div>
              <label for="agent_markup" class="block text-sm font-medium text-gray-700 mb-2">
                Agent Markup (RM)
              </label>
              <input
                type="number"
                id="agent_markup"
                name="agent_markup"
                value=""
                step="0.01"
                min="0"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Enter markup amount"
              >
              <p class="text-xs text-gray-500 mt-1">Additional markup by agent</p>
            </div>

            <div class="flex items-center h-full pt-6">
              <label class="flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  id="apply_sst"
                  name="apply_sst"
                  class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                >
                <span class="ml-2 text-sm font-medium text-gray-700">Apply SST</span>
              </label>
            </div>
          </div>
        </div>

        <!-- EPP Fees -->
        <div class="bg-gray-50 p-6 rounded-lg">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">EPP Fees (Optional)</h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="epp_fee_amount" class="block text-sm font-medium text-gray-700 mb-2">
                EPP Fee Amount (RM)
              </label>
              <input
                type="number"
                id="epp_fee_amount"
                name="epp_fee_amount"
                value=""
                step="0.01"
                min="0"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Enter total EPP fee"
              >
            </div>

            <div>
              <label for="epp_fee_description" class="block text-sm font-medium text-gray-700 mb-2">
                EPP Fee Description
              </label>
              <input
                type="text"
                id="epp_fee_description"
                name="epp_fee_description"
                value=""
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Maybank EPP 60 Months - RM15000, ..."
              >
              <p class="text-xs text-gray-500 mt-1">Describe EPP fee terms</p>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="flex justify-end">
          <button
            type="submit"
            class="px-8 py-3 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors"
          >
            Create Invoice
          </button>
        </div>
      </form>
    </div>

    <!-- Response Display -->
    <div id="invoiceResponse" class="hidden mx-6 mb-6">
      <div class="p-4 bg-green-50 border-l-4 border-green-400 rounded-lg">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 101.414 1.414z" clip-rule="evenodd"/>
            </svg>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-green-800">Invoice Created Successfully!</h3>
            <p class="text-sm text-green-700 mt-1">
              Invoice Number: <strong id="responseInvoiceNumber"></strong><br>
              Total Amount: RM <strong id="responseTotal"></strong>
            </p>
            <a id="invoiceLink" href="#" target="_blank" class="mt-3 inline-block px-4 py-2 bg-green-600 text-white text-sm font-semibold rounded hover:bg-green-700">
              View Invoice
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg shadow-lg">
        <svg class="animate-spin h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-sm text-gray-600 mt-2">Creating invoice...</p>
      </div>
    </div>

    <script>
      // Parse URL parameters
      const urlParams = new URLSearchParams(window.location.search);

      // Set form values from URL
      document.getElementById('package_id').value = urlParams.get('package_id') || '';
      document.getElementById('template_id').value = urlParams.get('template_id') || '';
      document.getElementById('customer_name').value = urlParams.get('customer_name') || '';
      document.getElementById('customer_phone').value = urlParams.get('customer_phone') || '';
      document.getElementById('customer_address').value = urlParams.get('customer_address') || '';
      document.getElementById('discount_given').value = urlParams.get('discount_given') || '';
      document.getElementById('apply_sst').checked = urlParams.get('apply_sst') === 'true';

      // Fetch package details if package_id is provided
      const packageId = urlParams.get('package_id');
      if (packageId) {
        fetchPackageDetails(packageId);
      } else {
        // Show warning if no package_id
        showWarning('ℹ️ No Package ID provided. You can enter a Package ID below or continue without one.');
      }

      async function fetchPackageDetails(packageId) {
        try {
          const response = await fetch(`/api/package/${packageId}`);
          const result = await response.json();

          if (result.success && result.package) {
            showPackage(result.package);
          } else {
            showError(`⚠️ Package Not Found: The Package ID '${packageId}' does not exist in database.`);
          }
        } catch (err) {
          console.error('Error fetching package:', err);
          showError(`⚠️ Database Error: Failed to check package. Error: ${err.message}`);
        }
      }

      function showPackage(pkg) {
        const packageInfo = document.getElementById('packageInfo');
        packageInfo.classList.remove('hidden');

        document.getElementById('packageName').textContent = pkg.name || 'N/A';
        document.getElementById('packagePrice').textContent = (pkg.price || '0').toFixed(2);
        document.getElementById('packageType').textContent = pkg.type || 'N/A';

        if (pkg.invoice_desc) {
          const descEl = document.getElementById('packageDesc');
          descEl.classList.remove('hidden');
          document.getElementById('packageDescText').textContent = pkg.invoice_desc;
        }
      }

      function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.classList.remove('hidden');
        document.getElementById('errorText').textContent = message;
      }

      function showWarning(message) {
        const warningDiv = document.getElementById('warningMessage');
        warningDiv.classList.remove('hidden');
        document.getElementById('warningText').textContent = message;
      }

      const form = document.getElementById('invoiceForm');
      const loadingSpinner = document.getElementById('loadingSpinner');
      const invoiceResponse = document.getElementById('invoiceResponse');
      const responseInvoiceNumber = document.getElementById('responseInvoiceNumber');
      const responseTotal = document.getElementById('responseTotal');
      const invoiceLink = document.getElementById('invoiceLink');

      form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Show loading spinner
        loadingSpinner.classList.remove('hidden');
        invoiceResponse.classList.add('hidden');

        // Get form data
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Convert checkbox to boolean
        data.apply_sst = formData.get('apply_sst') === 'on';

        // Convert numeric fields
        if (data.agent_markup) data.agent_markup = parseFloat(data.agent_markup);
        if (data.epp_fee_amount) data.epp_fee_amount = parseFloat(data.epp_fee_amount);

        try {
          const response = await fetch('/api/v1/invoices/on-the-fly', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });

          const result = await response.json();

          // Hide loading spinner
          loadingSpinner.classList.add('hidden');

          if (result.success) {
            // Show success response
            responseInvoiceNumber.textContent = result.invoice_number;
            responseTotal.textContent = result.total_amount.toFixed(2);
            invoiceLink.href = result.invoice_link;
            invoiceResponse.classList.remove('hidden');
          } else {
            // Show error
            alert('Failed to create invoice: ' + result.error);
          }
        } catch (err) {
          loadingSpinner.classList.add('hidden');
          alert('Error: ' + err.message);
        }
      });
    </script>
  </div>
</body>
</html>
