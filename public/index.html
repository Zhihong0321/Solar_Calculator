<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Calculator - TNB Bill Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#059669',
                        secondary: '#10b981',
                        accent: '#f59e0b',
                        dark: '#1f2937'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Container with max-width 450px on desktop -->
    <div class="w-full max-w-md mx-auto bg-white min-h-screen shadow-lg">

        <!-- Header -->
        <div class="bg-gradient-to-r from-primary to-secondary p-6 text-white">
            <div class="text-center">
                <div class="text-4xl mb-2">üåû</div>
                <h1 class="text-2xl font-bold">Solar Calculator</h1>
                <p class="text-emerald-100 text-sm mt-2">Calculate your solar savings with real TNB data</p>
            </div>
        </div>

        <!-- Connection Status -->
        <div class="p-4">
            <div id="dbStatus" class="flex items-center justify-center p-3 rounded-lg bg-yellow-50 border border-yellow-200">
                <div class="animate-spin rounded-full h-4 w-4 border-2 border-yellow-400 border-t-transparent mr-2"></div>
                <span class="text-yellow-700 text-sm">Checking database connection...</span>
            </div>
        </div>

        <!-- TNB Bill Input Section -->
        <div class="p-4">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="bg-primary text-white rounded-full w-8 h-8 flex items-center justify-center text-sm mr-3">1</span>
                    Enter Your TNB Bill
                </h2>

                <form id="billForm" class="space-y-4">
                    <div>
                        <label for="billAmount" class="block text-sm font-medium text-gray-700 mb-2">
                            Monthly TNB Bill Amount (RM)
                        </label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">RM</span>
                            <input
                                type="number"
                                id="billAmount"
                                name="billAmount"
                                step="0.01"
                                min="0"
                                placeholder="150.00"
                                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-lg"
                                required
                            >
                        </div>
                    </div>
                    <button
                        type="submit"
                        class="w-full bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center"
                    >
                        <span>Analyze My Bill</span>
                        <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                </form>
            </div>
        </div>

        <!-- Results Container -->
        <div id="calculatorResults" class="p-4 space-y-4"></div>

        <!-- Debug Section (Collapsible) -->
        <div class="p-4">
            <details class="bg-gray-100 rounded-lg">
                <summary class="p-4 cursor-pointer text-gray-600 font-medium">üîß Database Testing</summary>
                <div class="p-4 pt-0 space-y-2">
                    <button onclick="testConnection()" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-md text-sm">
                        Test DB Connection
                    </button>
                    <button onclick="getSchema()" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-md text-sm">
                        Get Schema
                    </button>
                    <button onclick="getTnbTariff()" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-md text-sm">
                        Get TNB Data
                    </button>
                    <button onclick="getPackageInfo()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md text-sm">
                        Get Package Info
                    </button>
                    <div id="results" class="mt-4"></div>
                </div>
            </details>
        </div>

        <!-- Footer -->
        <div class="p-4 text-center text-gray-500 text-xs border-t border-gray-200">
            <p>Powered by real TNB tariff data ‚Ä¢ Solar Calculator v2.0</p>
        </div>
    </div>

    <script>
        // Initialize
        window.onload = function() {
            testConnection();
        };

        // Form submission handler
        document.getElementById('billForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const billAmount = parseFloat(document.getElementById('billAmount').value);
            if (!billAmount || billAmount <= 0) {
                showNotification('Please enter a valid bill amount', 'error');
                return;
            }

            await calculateBillBreakdown(billAmount);
        });

        // Notification system
        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-50 border-green-200 text-green-700',
                error: 'bg-red-50 border-red-200 text-red-700',
                info: 'bg-blue-50 border-blue-200 text-blue-700'
            };

            const notification = document.createElement('div');
            notification.className = `fixed top-4 left-4 right-4 md:left-auto md:right-4 md:w-96 p-4 rounded-lg border ${colors[type]} z-50`;
            notification.innerHTML = `
                <div class="flex justify-between items-center">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-lg">&times;</button>
                </div>
            `;
            document.body.appendChild(notification);

            setTimeout(() => notification.remove(), 5000);
        }

        // Bill breakdown calculation
        async function calculateBillBreakdown(billAmount) {
            const resultsDiv = document.getElementById('calculatorResults');

            // Show loading
            resultsDiv.innerHTML = `
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-center">
                        <div class="animate-spin rounded-full h-6 w-6 border-2 border-primary border-t-transparent mr-3"></div>
                        <span class="text-gray-600">Finding closest TNB tariff data...</span>
                    </div>
                </div>
            `;

            try {
                const response = await fetch(`/api/calculate-bill?amount=${billAmount}`);
                const data = await response.json();

                if (response.ok) {
                    displayBillBreakdown(data);
                } else {
                    resultsDiv.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-xl p-6">
                            <div class="text-red-700 font-medium">Error</div>
                            <div class="text-red-600 text-sm mt-1">${data.error}</div>
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-xl p-6">
                        <div class="text-red-700 font-medium">Connection Error</div>
                        <div class="text-red-600 text-sm mt-1">${error.message}</div>
                    </div>
                `;
            }
        }

        // Display bill breakdown
        function displayBillBreakdown(data) {
            const resultsDiv = document.getElementById('calculatorResults');
            const tariff = data.tariff;

            resultsDiv.innerHTML = `
                <!-- TNB Bill Breakdown -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="bg-primary text-white p-4">
                        <h3 class="text-lg font-semibold flex items-center">
                            <span class="bg-white text-primary rounded-full w-8 h-8 flex items-center justify-center text-sm mr-3">2</span>
                            TNB Bill Breakdown
                        </h3>
                        <p class="text-emerald-100 text-sm mt-2">
                            Closest match: RM ${(parseFloat(tariff.bill_total_normal) || 0).toFixed(2)}
                            <span class="text-emerald-200">(Your input: RM ${data.inputAmount})</span>
                        </p>
                    </div>

                    <div class="p-4">
                        <div class="space-y-3">
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Usage</span>
                                <span class="font-medium">${tariff.usage_kwh || 0} kWh</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Usage Cost</span>
                                <span class="font-medium">RM ${(parseFloat(tariff.usage_normal) || 0).toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Network Fee</span>
                                <span class="font-medium">RM ${(parseFloat(tariff.network) || 0).toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Capacity Fee</span>
                                <span class="font-medium">RM ${(parseFloat(tariff.capacity) || 0).toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">Retail Charge</span>
                                <span class="font-medium">RM ${(parseFloat(tariff.retail) || 0).toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">EEI</span>
                                <span class="font-medium">RM ${(parseFloat(tariff.eei) || 0).toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">SST</span>
                                <span class="font-medium">RM ${(parseFloat(tariff.sst_normal) || 0).toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-600">KWTBB</span>
                                <span class="font-medium">RM ${(parseFloat(tariff.kwtbb_normal) || 0).toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between py-3 bg-primary/10 rounded-lg px-3 font-semibold text-lg">
                                <span class="text-primary">Total Bill</span>
                                <span class="text-primary">RM ${(parseFloat(tariff.bill_total_normal) || 0).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Solar Configuration -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                    <div class="bg-gradient-to-r from-accent to-orange-500 text-white p-4">
                        <h3 class="text-lg font-semibold flex items-center">
                            <span class="bg-white text-accent rounded-full w-8 h-8 flex items-center justify-center text-sm mr-3">3</span>
                            Solar Configuration
                        </h3>
                        <p class="text-orange-100 text-sm mt-2">Configure your solar setup parameters</p>
                    </div>

                    <div class="p-4 space-y-4">
                        <!-- Solar Parameters Grid -->
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Sun Peak Hours
                                </label>
                                <input
                                    type="number"
                                    id="sunPeakHour"
                                    step="0.1"
                                    min="3.0"
                                    max="4.5"
                                    value="3.4"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-accent focus:border-transparent"
                                >
                                <p class="text-xs text-gray-500 mt-1">Range: 3.0 - 4.5 hours</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Morning Usage (%)
                                </label>
                                <input
                                    type="number"
                                    id="morningUsage"
                                    min="1"
                                    max="100"
                                    value="30"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-accent focus:border-transparent"
                                >
                                <p class="text-xs text-gray-500 mt-1">Range: 1% - 100%</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    SMP Export Price (RM/kWh)
                                </label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">RM</span>
                                    <input
                                        type="number"
                                        id="smpPrice"
                                        step="0.01"
                                        min="0.19"
                                        max="0.27"
                                        value="0.20"
                                        class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-accent focus:border-transparent"
                                    >
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Range: RM 0.19 - RM 0.27</p>
                            </div>
                        </div>

                        <!-- Discounts Section -->
                        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                            <h4 class="font-medium text-amber-800 mb-3 flex items-center">
                                <span class="text-lg mr-2">üéØ</span>
                                Discounts & Promos
                            </h4>
                            <div class="grid grid-cols-1 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-amber-700 mb-1">
                                        Below 19 Panels Discount (RM)
                                    </label>
                                    <input
                                        type="number"
                                        id="below19Discount"
                                        step="0.01"
                                        min="0"
                                        value="0"
                                        class="w-full px-3 py-2 border border-amber-300 rounded-md focus:ring-2 focus:ring-amber-400 focus:border-transparent"
                                    >
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-amber-700 mb-1">
                                        Above 19 Panels Discount (RM)
                                    </label>
                                    <input
                                        type="number"
                                        id="above19Discount"
                                        step="0.01"
                                        min="0"
                                        value="0"
                                        class="w-full px-3 py-2 border border-amber-300 rounded-md focus:ring-2 focus:ring-amber-400 focus:border-transparent"
                                    >
                                </div>
                            </div>
                        </div>

                        <button
                            onclick="calculateSolarSavings()"
                            class="w-full bg-gradient-to-r from-accent to-orange-500 hover:from-accent/90 hover:to-orange-600 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-200 flex items-center justify-center"
                        >
                            <span class="text-lg mr-2">‚ö°</span>
                            Calculate Solar Savings
                        </button>
                    </div>
                </div>
            `;
        }

        // Solar savings calculation
        async function calculateSolarSavings() {
            const billAmount = parseFloat(document.getElementById('billAmount').value);
            const sunPeakHour = parseFloat(document.getElementById('sunPeakHour').value);
            const morningUsage = parseFloat(document.getElementById('morningUsage').value);
            const smpPrice = parseFloat(document.getElementById('smpPrice').value);
            const below19Discount = parseFloat(document.getElementById('below19Discount').value) || 0;
            const above19Discount = parseFloat(document.getElementById('above19Discount').value) || 0;

            // Validation
            if (!billAmount || billAmount <= 0) {
                showNotification('Please calculate TNB bill breakdown first', 'error');
                return;
            }

            if (!sunPeakHour || sunPeakHour < 3.0 || sunPeakHour > 4.5) {
                showNotification('Sun Peak Hour must be between 3.0 and 4.5', 'error');
                return;
            }

            if (!morningUsage || morningUsage < 1 || morningUsage > 100) {
                showNotification('Morning Usage must be between 1% and 100%', 'error');
                return;
            }

            if (!smpPrice || smpPrice < 0.19 || smpPrice > 0.27) {
                showNotification('SMP price must be between RM 0.19 and RM 0.27', 'error');
                return;
            }

            const resultsDiv = document.getElementById('calculatorResults');

            // Add loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'bg-white rounded-xl shadow-sm border border-gray-200 p-6';
            loadingDiv.innerHTML = `
                <div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-6 w-6 border-2 border-secondary border-t-transparent mr-3"></div>
                    <span class="text-gray-600">Calculating solar savings...</span>
                </div>
            `;
            resultsDiv.appendChild(loadingDiv);

            try {
                const params = new URLSearchParams({
                    amount: billAmount,
                    sunPeakHour: sunPeakHour,
                    morningUsage: morningUsage,
                    smpPrice: smpPrice,
                    below19Discount: below19Discount,
                    above19Discount: above19Discount
                });

                const response = await fetch(`/api/solar-calculation?${params}`);
                const data = await response.json();

                loadingDiv.remove();

                if (response.ok) {
                    // Show popup with panel recommendation first
                    showPanelRecommendationPopup(data);
                } else {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'bg-red-50 border border-red-200 rounded-xl p-6';
                    errorDiv.innerHTML = `
                        <div class="text-red-700 font-medium">Calculation Error</div>
                        <div class="text-red-600 text-sm mt-1">${data.error}</div>
                    `;
                    resultsDiv.appendChild(errorDiv);
                }
            } catch (error) {
                loadingDiv.remove();
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Display solar calculation results
        function displaySolarCalculation(data) {
            const resultsDiv = document.getElementById('calculatorResults');

            const solarDiv = document.createElement('div');
            solarDiv.className = 'bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden';
            solarDiv.innerHTML = `
                <div class="bg-gradient-to-r from-secondary to-emerald-600 text-white p-4">
                    <h3 class="text-lg font-semibold flex items-center">
                        <span class="bg-white text-secondary rounded-full w-8 h-8 flex items-center justify-center text-sm mr-3">4</span>
                        Solar Savings Results
                    </h3>
                    <p class="text-emerald-100 text-sm mt-2">
                        ${data.config.sunPeakHour}h peak ‚Ä¢ ${data.config.morningUsage}% morning ‚Ä¢ RM ${data.config.smpPrice}/kWh export
                    </p>
                </div>

                <div class="p-4">
                    <div class="space-y-3">
                        <div class="flex justify-between py-2 border-b border-gray-100">
                            <span class="text-gray-600">System Size</span>
                            <span class="font-medium">${data.solarConfig}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-100">
                            <span class="text-gray-600">Monthly Savings</span>
                            <span class="font-medium text-green-600">RM ${data.monthlySavings}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-100">
                            <span class="text-gray-600">System Cost (Before Discount)</span>
                            <span class="font-medium">RM ${data.systemCostBeforeDiscount}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-100">
                            <span class="text-gray-600">Discount Applied</span>
                            <span class="font-medium text-orange-600">-RM ${data.discount}</span>
                        </div>
                        <div class="flex justify-between py-3 bg-secondary/10 rounded-lg px-3 font-semibold text-lg">
                            <span class="text-secondary">Final System Cost</span>
                            <span class="text-secondary">RM ${data.finalSystemCost}</span>
                        </div>
                        <div class="flex justify-between py-3 bg-accent/10 rounded-lg px-3 font-semibold text-lg">
                            <span class="text-accent">Payback Period</span>
                            <span class="text-accent">${data.paybackPeriod} years</span>
                        </div>
                    </div>
                </div>
            `;
            resultsDiv.appendChild(solarDiv);

            // Smooth scroll to results
            solarDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Database connection test
        async function testConnection() {
            const statusDiv = document.getElementById('dbStatus');
            statusDiv.className = 'flex items-center justify-center p-3 rounded-lg bg-yellow-50 border border-yellow-200';
            statusDiv.innerHTML = `
                <div class="animate-spin rounded-full h-4 w-4 border-2 border-yellow-400 border-t-transparent mr-2"></div>
                <span class="text-yellow-700 text-sm">Testing database connection...</span>
            `;

            try {
                const response = await fetch('/api/health');
                const data = await response.json();

                if (response.ok) {
                    statusDiv.className = 'flex items-center justify-center p-3 rounded-lg bg-green-50 border border-green-200';
                    statusDiv.innerHTML = `
                        <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        <span class="text-green-700 text-sm">Database connected successfully!</span>
                    `;
                } else {
                    statusDiv.className = 'flex items-center justify-center p-3 rounded-lg bg-red-50 border border-red-200';
                    statusDiv.innerHTML = `
                        <svg class="w-4 h-4 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <span class="text-red-700 text-sm">Database connection failed</span>
                    `;
                }
            } catch (error) {
                statusDiv.className = 'flex items-center justify-center p-3 rounded-lg bg-red-50 border border-red-200';
                statusDiv.innerHTML = `
                    <svg class="w-4 h-4 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    <span class="text-red-700 text-sm">Connection error: ${error.message}</span>
                `;
            }
        }

        // Debug functions for testing (simplified)
        async function getSchema() {
            document.getElementById('results').innerHTML = '<div class="text-sm text-gray-600 p-2 bg-gray-100 rounded">Loading schema...</div>';
            try {
                const response = await fetch('/api/schema');
                const data = await response.json();
                document.getElementById('results').innerHTML = `<pre class="text-xs bg-gray-100 p-2 rounded overflow-x-auto">${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                document.getElementById('results').innerHTML = `<div class="text-sm text-red-600 p-2 bg-red-100 rounded">Error: ${error.message}</div>`;
            }
        }

        async function getTnbTariff() {
            document.getElementById('results').innerHTML = '<div class="text-sm text-gray-600 p-2 bg-gray-100 rounded">Loading TNB data...</div>';
            try {
                const response = await fetch('/api/tnb-tariff');
                const data = await response.json();
                document.getElementById('results').innerHTML = `<pre class="text-xs bg-gray-100 p-2 rounded overflow-x-auto">${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                document.getElementById('results').innerHTML = `<div class="text-sm text-red-600 p-2 bg-red-100 rounded">Error: ${error.message}</div>`;
            }
        }

        async function getPackageInfo() {
            document.getElementById('results').innerHTML = '<div class="text-sm text-gray-600 p-2 bg-gray-100 rounded">Loading package info...</div>';
            try {
                const response = await fetch('/api/package-info');
                const data = await response.json();
                document.getElementById('results').innerHTML = `<pre class="text-xs bg-gray-100 p-2 rounded overflow-x-auto">${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                document.getElementById('results').innerHTML = `<div class="text-sm text-red-600 p-2 bg-red-100 rounded">Error: ${error.message}</div>`;
            }
        }

        // Show panel recommendation popup
        function showPanelRecommendationPopup(data) {
            const popup = document.createElement('div');
            popup.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';

            const packageInfo = data.selectedPackage ?
                `<div class="text-emerald-600 font-medium mt-3">
                    üì¶ Selected Package: ${data.selectedPackage.packageName}
                    <div class="text-sm text-gray-600 mt-1">
                        Price: RM ${parseFloat(data.selectedPackage.price).toLocaleString('en-MY', {minimumFractionDigits: 2})}
                    </div>
                </div>` :
                `<div class="text-amber-600 font-medium mt-3">
                    ‚ö†Ô∏è No package found for ${data.recommendedPanels} panels
                </div>`;

            popup.innerHTML = `
                <div class="bg-white rounded-xl shadow-xl max-w-sm w-full max-h-screen overflow-y-auto">
                    <div class="bg-gradient-to-r from-primary to-secondary text-white p-6 text-center">
                        <div class="text-4xl mb-2">‚ö°</div>
                        <h3 class="text-xl font-bold">Solar System Recommendation</h3>
                    </div>

                    <div class="p-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-primary">${data.recommendedPanels}</div>
                            <div class="text-gray-600 text-lg">Recommended Panels</div>

                            ${packageInfo}

                            <div class="text-sm text-gray-500 mt-4 p-3 bg-gray-50 rounded">
                                Formula: ${data.details.monthlyUsageKwh} kWh √∑ ${data.config.sunPeakHour}h √∑ 30 √∑ 0.62 = ${data.recommendedPanels} panels
                            </div>
                        </div>

                        <div class="flex gap-3 mt-6">
                            <button
                                onclick="this.parentElement.parentElement.parentElement.parentElement.remove()"
                                class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-4 rounded-lg transition-colors"
                            >
                                Close
                            </button>
                            <button
                                onclick="this.parentElement.parentElement.parentElement.parentElement.remove(); displaySolarCalculation(arguments[0]); showNotification('Solar savings calculated successfully!', 'success');"
                                class="flex-1 bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-4 rounded-lg transition-colors"
                            >
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Store data for the View Details button
            popup.querySelector('button:last-child').onclick = function() {
                popup.remove();
                displaySolarCalculation(data);
                showNotification('Solar savings calculated successfully!', 'success');
            };

            document.body.appendChild(popup);
        }
    </script>
</body>
</html>